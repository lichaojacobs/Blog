<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="jacobs的个人博客">
    <meta name="keyword" content="null">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="CHAO LI" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        CHAO LI｜CHAO LI&#39;s blog
        
    </title>

    <link rel="canonical" href="http://jacobs.wanhb.cn/2017/02/12/Spring源码解析-事务处理/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('http://ol7zjjc80.bkt.clouddn.com/lion-blur-bg.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    CHAO LI
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    
                        
                        <li>
                            <a href="/archives/">archives</a>
                        </li>
                        
                    
                        
                        <li>
                            <a href="/tags/">tags</a>
                        </li>
                        
                    

                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="http://ol7zjjc80.bkt.clouddn.com/16-8-new-bg.jpg">


<style>
    
    header.intro-header {
        background-image: url('http://ol7zjjc80.bkt.clouddn.com/16-8-new-bg.jpg')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>Spring源码解析--事务处理</h1>
                    
                    <span class="meta">
                         作者 CHAO LI
                        <span>
                          日期 2017-02-12
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#spring"
                           title="spring">spring</a>
                        
                        <a class="tag" href="/tags/#ioc"
                           title="ioc">ioc</a>
                        
                        <a class="tag" href="/tags/#aop"
                           title="aop">aop</a>
                        
                        <a class="tag" href="/tags/#源码"
                           title="源码">源码</a>
                        
                        <a class="tag" href="/tags/#事务处理"
                           title="事务处理">事务处理</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            Spring源码解析--事务处理
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <h3 id="事务处理相关类的层次结构"><a href="#事务处理相关类的层次结构" class="headerlink" title="事务处理相关类的层次结构"></a>事务处理相关类的层次结构</h3><p><img src="http://ol7zjjc80.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-11%20%E4%B8%8B%E5%8D%887.54.25.png" alt="事务处理相关类的层次结构"></p>
<p>在 Spring事务处理中，可以通过设计一个TransactionProxyFactoryBean来使用AOP功能，通过它可以生成Proxy代理对象。在代理对象中，通过TranscationInterceptor来完成对代理对象方法的拦截。实现声明式事务处理时，是AOP和IOC集成的部分，而对于具体的事物处理实现，是通过设计PlatformTransactionManager，AbstractPlatforTransactionmanager以及一系列具体事务处理器来实现的。PlatformTransactionManager又实现了TransactionInterceptor，这样就能将一系列处理给串联起来。</p>
<h3 id="Spring声明式事务处理"><a href="#Spring声明式事务处理" class="headerlink" title="Spring声明式事务处理"></a>Spring声明式事务处理</h3><h4 id="设计原理与过程"><a href="#设计原理与过程" class="headerlink" title="设计原理与过程"></a>设计原理与过程</h4><p>在实现声明式的事务处理时，常用的方式是结合IOC容器和Spring已有的TransactionProxyFactoryBean对事务管理进行配置，实现可分为以下几个步骤：</p>
<ul>
<li>读取和处理在IOC容器中配置的事务处理属性，并转化为Spring事务处理需要的内部数据结构。</li>
<li>Spring事务处理模块实现统一的事务处理过程。</li>
<li>底层的事务处理实现。Spring委托给具体的事务处理器来完成。</li>
</ul>
<p><img src="http://ol7zjjc80.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-11%20%E4%B8%8B%E5%8D%888.23.09.png" alt="建立事务处理对象时序图"></p>
<p>从TransactionProxyFactoryBean入手，通过代码来了解Spring是如何通过AOP功能来完成事务管理配置的，从图中可以看到Spring为声明式事务处理的实现所做的一些准备工作：包括为AOP配置基础设施，这些基础设施包括设置拦截器TransactionInterceptor、通过DefaultPointcutAdvisor或TransactionAttributeSourceAdvisor。同时，在TransactionProxyFactoryBean的实现中，还可以看到注入进来的PlatformTransactionManager和事务处理属性TransactionAttribute等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public class TransactionProxyFactoryBean extends AbstractSingletonProxyFactoryBean implements BeanFactoryAware &#123;</div><div class="line">  private final TransactionInterceptor transactionInterceptor = new TransactionInterceptor();／／这个拦截器通过AOP发挥作用，通过这个拦截器的实现，Spring封装了事务处理实现</div><div class="line">  private Pointcut pointcut;</div><div class="line"></div><div class="line">  public TransactionProxyFactoryBean() &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setTransactionManager(PlatformTransactionManager transactionManager) &#123;</div><div class="line">    this.transactionInterceptor.setTransactionManager(transactionManager);</div><div class="line">  &#125;</div><div class="line">  //通过依赖注入的事务属性以Properties的形式出现，把BeanDefinition中读到的事务管理的属性信息注入到TransactionInterceptor中</div><div class="line">  public void setTransactionAttributes(Properties transactionAttributes) &#123;</div><div class="line">    this.transactionInterceptor.setTransactionAttributes(transactionAttributes);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setTransactionAttributeSource(TransactionAttributeSource transactionAttributeSource) &#123;</div><div class="line">    this.transactionInterceptor.setTransactionAttributeSource(transactionAttributeSource);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setPointcut(Pointcut pointcut) &#123;</div><div class="line">    this.pointcut = pointcut;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setBeanFactory(BeanFactory beanFactory) &#123;</div><div class="line">    this.transactionInterceptor.setBeanFactory(beanFactory);</div><div class="line">  &#125;</div><div class="line">//这里创建Spring  AOP对事务处理的Advisor</div><div class="line">  protected Object createMainInterceptor() &#123;</div><div class="line">    this.transactionInterceptor.afterPropertiesSet();//事务处理完成AOP配置的地方</div><div class="line">    return this.pointcut != null?new DefaultPointcutAdvisor(this.pointcut, this.transactionInterceptor):new TransactionAttributeSourceAdvisor(this.transactionInterceptor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  protected void postProcessProxyFactory(ProxyFactory proxyFactory) &#123;</div><div class="line">    proxyFactory.addInterface(TransactionalProxy.class);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成了AOP配置，Spring的TransactionInterceptor配置是IOC容器完成Bean的依赖注入时，通过initializeBean方法被调用。</p>
<p>   在建立TransactionProxyFactoryBean的事务处理拦截器的时候， afterPropertiesSet方法首先对 ProxyFactoryBean的目标Bean设置进行检查，如果这个目标Bean的设置是正确的，就会创建ProxyFactory对象，从而实现AOP的使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void afterPropertiesSet() &#123;</div><div class="line">  if(this.getTransactionManager() == null &amp;&amp; this.beanFactory == null) &#123;</div><div class="line">    throw new IllegalStateException(&quot;Set the \&apos;transactionManager\&apos; property or make sure to run within a BeanFactory containing a PlatformTransactionManager bean!&quot;);</div><div class="line">  &#125; else if(this.getTransactionAttributeSource() == null) &#123;</div><div class="line">    throw new IllegalStateException(&quot;Either \&apos;transactionAttributeSource\&apos; or \&apos;transactionAttributes\&apos; is required: If there are no transactional methods, then don\&apos;t use a transaction aspect.&quot;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="事务处理配置的读入"><a href="#事务处理配置的读入" class="headerlink" title="事务处理配置的读入"></a>事务处理配置的读入</h4><p>在AOP配置完成的基础上，以TransactionAttributeSourceAdvisor的实现为入口，了解具体的事务属性配置是如何读入的，实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private TransactionInterceptor transactionInterceptor;／／同样需要AOP中用到的Interceptro和Pointcut，通过内部类，调用TransactionInterceptor来得到事务的配置属性，在对Proxy的方法进行匹配调用时，会使用到这些配置属性。</div><div class="line">private final TransactionAttributeSourcePointcut pointcut = new TransactionAttributeSourcePointcut() &#123;</div><div class="line">  protected TransactionAttributeSource getTransactionAttributeSource() &#123;</div><div class="line">    return TransactionAttributeSourceAdvisor.this.transactionInterceptor != null?TransactionAttributeSourceAdvisor.this.transactionInterceptor.getTransactionAttributeSource():null;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在声明式事务处理中，通过对目标对象的方法调用进行拦截实现，这个拦截通过AOP发挥作用。在AOP中，对于拦截的启动，首先需要对方法调用是否需要拦截进行判断，依据时那些在TransactionProxyFactoryBean中为目标对象设置的事务属性。这个匹配判断在TransactionAttributeSourcePointcut中完成。实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public boolean matches(Method method, Class&lt;?&gt; targetClass) &#123;</div><div class="line">  if(TransactionalProxy.class.isAssignableFrom(targetClass)) &#123;</div><div class="line">    return false;</div><div class="line">  &#125; else &#123;</div><div class="line">    TransactionAttributeSource tas = this.getTransactionAttributeSource();</div><div class="line">    return tas == null || tas.getTransactionAttribute(method, targetClass) != null;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在方法中，首先把事务方法的属性配置读取到TransactionAttributeSource对象中，有了这些事务处理的配置以后，根据当前方法调用的method对象和目标对象，对是否需要启动事务处理拦截器进行判断。</p>
<p>在Pointcut的matches判断过程中，会用到transactionAttributeSource对象，这个transactionAttributeSource对象是在对TransactionInterceptor进行依赖注入时就配置好的，它的设置是在TransactionInterceptor的基类TransactionAspectSupport中完成的。配置的是一个NameMatchTransactionAttributeSouce对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void setTransactionAttributes(Properties transactionAttributes) &#123;</div><div class="line">  NameMatchTransactionAttributeSource tas = new NameMatchTransactionAttributeSource();</div><div class="line">  tas.setProperties(transactionAttributes);</div><div class="line">  this.transactionAttributeSource = tas;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可知，NameMatchTransactionAttributeSouce作为TransacionAttributeSource的具体实现，是实际完成事务处理属性读入和匹配的地方。对于NameMatchTransactionAttributeSouce是怎样实现事务处理属性的读入和匹配的，可看如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">public void setProperties(Properties transactionAttributes) &#123;//设置配置的事务方法</div><div class="line">  TransactionAttributeEditor tae = new TransactionAttributeEditor();</div><div class="line">  Enumeration propNames = transactionAttributes.propertyNames();</div><div class="line"></div><div class="line">  while(propNames.hasMoreElements()) &#123;</div><div class="line">    String methodName = (String)propNames.nextElement();</div><div class="line">    String value = transactionAttributes.getProperty(methodName);</div><div class="line">    tae.setAsText(value);</div><div class="line">    TransactionAttribute attr = (TransactionAttribute)tae.getValue();</div><div class="line">    this.addTransactionalMethod(methodName, attr);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">private Map&lt;String, TransactionAttribute&gt; nameMap = new HashMap();</div><div class="line"></div><div class="line"></div><div class="line">public void addTransactionalMethod(String methodName, TransactionAttribute attr) &#123;</div><div class="line">  if(logger.isDebugEnabled()) &#123;</div><div class="line">    logger.debug(&quot;Adding transactional method [&quot; + methodName + &quot;] with attribute [&quot; + attr + &quot;]&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  this.nameMap.put(methodName, attr);</div><div class="line">&#125;</div><div class="line">／／对调用的方法进行判断，判断它是否是事务方法，如果是，那么取出相应的事务配置属性</div><div class="line">public TransactionAttribute getTransactionAttribute(Method method, Class&lt;?&gt; targetClass) &#123;</div><div class="line">  if(!ClassUtils.isUserLevelMethod(method)) &#123;</div><div class="line">    return null;</div><div class="line">  &#125; else &#123;</div><div class="line">    String methodName = method.getName();／／判断当前目标调用的方法与配置的事务方法是否直接匹配</div><div class="line">    TransactionAttribute attr = (TransactionAttribute)this.nameMap.get(methodName);</div><div class="line">    if(attr == null) &#123;//如果不能直接匹配，就通过调用PatternMatchUtils的simpleMatch方法来进行匹配判断。</div><div class="line">      String bestNameMatch = null;</div><div class="line">      Iterator var6 = this.nameMap.keySet().iterator();</div><div class="line"></div><div class="line">      while(true) &#123;</div><div class="line">        String mappedName;</div><div class="line">        do &#123;</div><div class="line">          do &#123;</div><div class="line">            if(!var6.hasNext()) &#123;</div><div class="line">              return attr;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mappedName = (String)var6.next();</div><div class="line">          &#125; while(!this.isMatch(methodName, mappedName));</div><div class="line">        &#125; while(bestNameMatch != null &amp;&amp; bestNameMatch.length() &gt; mappedName.length());</div><div class="line"></div><div class="line">        attr = (TransactionAttribute)this.nameMap.get(mappedName);</div><div class="line">        bestNameMatch = mappedName;</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      return attr;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">／／事务方法的匹配判断，详细的匹配过程在PatternMatchUtils中实现</div><div class="line">protected boolean isMatch(String methodName, String mappedName) &#123;</div><div class="line">  return PatternMatchUtils.simpleMatch(mappedName, methodName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="事务处理拦截器的设计与实现："><a href="#事务处理拦截器的设计与实现：" class="headerlink" title="事务处理拦截器的设计与实现："></a>事务处理拦截器的设计与实现：</h4><p>经过TransactionProxyFactoryBean的AOP包装，此时如果对目标对象进行方法调用，起作用的对象实际傻姑娘是一个Proxy代理对象。对目标对象方法的调用，不会直接作用在TransactionProxyFactoryBean设置的目标对象上。而是会被设置的事务处理器拦截。而在TransactionProxyFactoryBean的AOP实现中，获取Proxy对象的过程并不复杂，TransactionProxyFactoryBean作为一个FactoryBean，对Bean对象的引用通过getObejct方法来得到的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public Object getObject() &#123; ／／TransactionProxyFactoryBean 的父类 AbstractSingletonProxyFactoryBean中</div><div class="line">／／返回的是一个Proxy，是ProxyFactory生成的AOP代理，已经封装了对事务处理的拦截器设置</div><div class="line">  if(this.proxy == null) &#123;</div><div class="line">    throw new FactoryBeanNotInitializedException();</div><div class="line">  &#125; else &#123;</div><div class="line">    return this.proxy;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于AOP代理对象的作用方法入口，我们一般都知道invoke方法，这个invke方法在事务处理拦截器TransactionInterceptor中，实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</div><div class="line">  Class targetClass = invocation.getThis() != null?AopUtils.getTargetClass(invocation.getThis()):null;</div><div class="line">  return this.invokeWithinTransaction(invocation.getMethod(), targetClass, new InvocationCallback() &#123;</div><div class="line">    public Object proceedWithInvocation() throws Throwable &#123;</div><div class="line">      return invocation.proceed();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line">protected Object invokeWithinTransaction(Method method, Class&lt;?&gt; targetClass, final TransactionAspectSupport.InvocationCallback invocation) throws Throwable &#123;</div><div class="line">  final TransactionAttribute txAttr = this.getTransactionAttributeSource().getTransactionAttribute(method, targetClass);／／这里读取事务的属性配置，通过TransactionAttributeSource对象取得</div><div class="line">  final PlatformTransactionManager tm = this.determineTransactionManager(txAttr);／／根据TransactionProxyFactoryBean的配置信息获得具体的事务处理器</div><div class="line">  final String joinpointIdentification = this.methodIdentification(method, targetClass, txAttr);</div><div class="line">  if(txAttr != null &amp;&amp; tm instanceof CallbackPreferringPlatformTransactionManager) &#123;</div><div class="line">    try &#123;</div><div class="line">      Object ex1 = ((CallbackPreferringPlatformTransactionManager)tm).execute(txAttr, new TransactionCallback() &#123;</div><div class="line">        public Object doInTransaction(TransactionStatus status) &#123;</div><div class="line">          TransactionAspectSupport.TransactionInfo txInfo = TransactionAspectSupport.this.prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);／／创建事务，同时把事务过程中得到的信息放到TransactionInfo中去，TransactionInfo是保存当前事务状态的对象。</div><div class="line"></div><div class="line">          TransactionAspectSupport.ThrowableHolder var4;</div><div class="line">          try &#123;</div><div class="line">            Object ex = invocation.proceedWithInvocation();</div><div class="line">            return ex;</div><div class="line">          &#125; catch (Throwable var8) &#123;</div><div class="line">            if(txAttr.rollbackOn(var8)) &#123;</div><div class="line">              if(var8 instanceof RuntimeException) &#123;</div><div class="line">                throw (RuntimeException)var8;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              throw new TransactionAspectSupport.ThrowableHolderException(var8);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            var4 = new TransactionAspectSupport.ThrowableHolder(var8);</div><div class="line">          &#125; finally &#123;</div><div class="line">            TransactionAspectSupport.this.cleanupTransactionInfo(txInfo);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          return var4;</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">      if(ex1 instanceof TransactionAspectSupport.ThrowableHolder) &#123;</div><div class="line">        throw ((TransactionAspectSupport.ThrowableHolder)ex1).getThrowable();</div><div class="line">      &#125; else &#123;</div><div class="line">        return ex1;</div><div class="line">      &#125;</div><div class="line">    &#125; catch (TransactionAspectSupport.ThrowableHolderException var14) &#123;</div><div class="line">      throw var14.getCause();</div><div class="line">    &#125;</div><div class="line">  &#125; else &#123;</div><div class="line">    TransactionAspectSupport.TransactionInfo ex = this.createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</div><div class="line">    Object retVal = null;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">      retVal = invocation.proceedWithInvocation();／／这里的调用使处理沿着拦截器链进行，使最后目标对象的方法得到调用</div><div class="line">    &#125; catch (Throwable var15) &#123;</div><div class="line">      this.completeTransactionAfterThrowing(ex, var15);／／如果事务处理方法中调用出现了异常，事务处理如何进行需要根据具体情况考虑是否会滚或者提交</div><div class="line">      throw var15;</div><div class="line">    &#125; finally &#123;</div><div class="line">      this.cleanupTransactionInfo(ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    this.commitTransactionAfterReturning(ex);//这里通过事务处理器来对事务进行提交</div><div class="line">    return retVal;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于Spring而言，事务管理实际上是通过一个TransactionInfo对象来完成的，在该对象中，封装了事务对象和事务处理的状态信息，这是事务处理的抽象。在这一步完成以后，会对拦截器链进行处理，因为有可能在该事务对象中还配置了除事务处理AOP之外的其他拦截器，在结束对拦截器链处理之后，会对 TransactionInfo中的信息进行更新，以反映最近的事务处理情况，在这个时候，也就完成了事务提交的准备，通过调用事务处理器PlatformTransactionManager的commitTransactionAfterReturning方法来完成事务的提交。这个提交的处理过程已经封装在事务处理器中了，而与具体数据源相关的处理过程，最终委托给相关的事务处理器完成，如：DataSourceTransactionManager、HibernateTransactionManager等。</p>
<p><img src="http://ol7zjjc80.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-11%20%E4%B8%8B%E5%8D%8810.51.15.png" alt="事务提交时序图"></p>
<p>这个invoke方法的实现中，可以看到整个事务处理在AOP拦截器中实现的全过程。同时，它也是Spring采用AOP封装事务处理和实现声明式事务处理的核心部分。</p>
<h3 id="Spring事务处理的设计与实现"><a href="#Spring事务处理的设计与实现" class="headerlink" title="Spring事务处理的设计与实现"></a>Spring事务处理的设计与实现</h3><h4 id="Spring事务传播属性"><a href="#Spring事务传播属性" class="headerlink" title="Spring事务传播属性"></a>Spring事务传播属性</h4><blockquote>
<p>PROPAGATION_REQUIRED – 支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择。<br>PROPAGATION_SUPPORTS – 支持当前事务，如果当前没有事务，就以非事务方式执行。<br>PROPAGATION_MANDATORY – 支持当前事务，如果当前没有事务，就抛出异常。<br>PROPAGATION_REQUIRES_NEW – 新建事务，如果当前存在事务，把当前事务挂起。<br>PROPAGATION_NOT_SUPPORTED – 以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。<br>PROPAGATION_NEVER – 以非事务方式执行，如果当前存在事务，则抛出异常。  PROPAGATION_NESTED –<br>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则进行与PROPAGATION_REQUIRED类似的操作。<br>前六个策略类似于EJB CMT，第七个（PROPAGATION_NESTED）是Spring所提供的一个特殊变量。</p>
</blockquote>
<h4 id="事务的创建"><a href="#事务的创建" class="headerlink" title="事务的创建"></a>事务的创建</h4><p>声明式事务中，TransactionInterceptor拦截器的invoke方法作为事务处理实现的起点，invoke方法中createTransactionIfNeccessary方法作为事务创建的入口。以下是createTransactionIfNeccessary方法的时序图</p>
<p><img src="http://ol7zjjc80.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-11%20%E4%B8%8B%E5%8D%8811.09.41.png" alt="createTransactionIfNeccessary方法的时序图"></p>
<p>在createTransactionIfNeccessary中首先会向AbstractTransactionManager执行getTransaction，这个获取Transaction事务对象的过程，在AbstractTransactionManager中需要对事务不同的情况作出处理，然后创建一个TransactionStatus，并把这个TransactionStatus设置到对应的TransactionInfo中去，同时将TransactionInfo和当前的线程绑定，从而完成事务的创建过程。TransactionStatus和TransactionInfo这俩个对象持有的数据是事务处理器对事务进行处理的主要依据。对这俩个对象的使用贯穿整个事务处理的全过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">protected TransactionAspectSupport.TransactionInfo createTransactionIfNecessary(PlatformTransactionManager tm, final TransactionAttribute txAttr, final String joinpointIdentification) &#123;</div><div class="line">  if(txAttr != null &amp;&amp; ((TransactionAttribute)txAttr).getName() == null) &#123;</div><div class="line">    txAttr = new DelegatingTransactionAttribute((TransactionAttribute)txAttr) &#123;</div><div class="line">      public String getName() &#123;</div><div class="line">        return joinpointIdentification;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  TransactionStatus status = null;</div><div class="line">  if(txAttr != null) &#123;</div><div class="line">    if(tm != null) &#123;</div><div class="line">      status = tm.getTransaction((TransactionDefinition)txAttr);／／这里使用了定义好的事务方法的配置信息。事务创建由事务处理器来完成，同时返回TransactionStatus来记录当前的事务状态，包括已经创建的事务。</div><div class="line">    &#125; else if(this.logger.isDebugEnabled()) &#123;</div><div class="line">      this.logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification + &quot;] because no transaction manager has been configured&quot;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return this.prepareTransactionInfo(tm, (TransactionAttribute)txAttr, joinpointIdentification, status);</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected TransactionAspectSupport.TransactionInfo prepareTransactionInfo(PlatformTransactionManager tm, TransactionAttribute txAttr, String joinpointIdentification, TransactionStatus status) &#123;</div><div class="line">  TransactionAspectSupport.TransactionInfo txInfo = new TransactionAspectSupport.TransactionInfo(tm, txAttr, joinpointIdentification);</div><div class="line">  if(txAttr != null) &#123;</div><div class="line">    if(this.logger.isTraceEnabled()) &#123;</div><div class="line">      this.logger.trace(&quot;Getting transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    txInfo.newTransactionStatus(status);</div><div class="line">  &#125; else if(this.logger.isTraceEnabled()) &#123;</div><div class="line">    this.logger.trace(&quot;Don\&apos;t need to create transaction for [&quot; + joinpointIdentification + &quot;]: This method isn\&apos;t transactional.&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  txInfo.bindToThread();</div><div class="line">  return txInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getTansaction实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public final TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException &#123;</div><div class="line">       Object transaction = doGetTransaction();</div><div class="line"></div><div class="line">       // Cache debug flag to avoid repeated checks.</div><div class="line">       boolean debugEnabled = logger.isDebugEnabled();</div><div class="line"></div><div class="line">       if (definition == null) &#123;</div><div class="line">              // Use defaults if no transaction definition given.</div><div class="line">              definition = new DefaultTransactionDefinition();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (isExistingTransaction(transaction)) &#123;</div><div class="line">              // Existing transaction found -&gt; check propagation behavior to find out how to behave.</div><div class="line">              return handleExistingTransaction(definition, transaction, debugEnabled);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Check definition settings for new transaction.</div><div class="line">       if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</div><div class="line">              throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, definition.getTimeout());</div><div class="line">       &#125;</div><div class="line">／／没有事务存在，需要根据事务传播属性设置来创建事务，这里会看到事务传播属性的设置：mandatory、required required_new nested等</div><div class="line">       // No existing transaction found -&gt; check propagation behavior to find out how to proceed.</div><div class="line">       if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</div><div class="line">              throw new IllegalTransactionStateException(</div><div class="line">                            &quot;No existing transaction found for transaction marked with propagation &apos;mandatory&apos;&quot;);</div><div class="line">       &#125;</div><div class="line">       else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</div><div class="line">                     definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</div><div class="line">                     definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</div><div class="line">              SuspendedResourcesHolder suspendedResources = suspend(null);</div><div class="line">              if (debugEnabled) &#123;</div><div class="line">                     logger.debug(&quot;Creating new transaction with name [&quot; + definition.getName() + &quot;]: &quot; + definition);</div><div class="line">              &#125;</div><div class="line">              try &#123;</div><div class="line">                     boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">                     DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">                                   definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">                     doBegin(transaction, definition);</div><div class="line">                     prepareSynchronization(status, definition);</div><div class="line">                     return status;</div><div class="line">              &#125;</div><div class="line">              catch (RuntimeException ex) &#123;</div><div class="line">                     resume(null, suspendedResources);</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (Error err) &#123;</div><div class="line">                     resume(null, suspendedResources);</div><div class="line">                     throw err;</div><div class="line">              &#125;</div><div class="line">       &#125;</div><div class="line">       else &#123;</div><div class="line">              // Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</div><div class="line">              if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</div><div class="line">                     logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; +</div><div class="line">                                   &quot;isolation level will effectively be ignored: &quot; + definition);</div><div class="line">              &#125;</div><div class="line">              boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</div><div class="line">              return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null);</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>handleExsitingTransaction方法是理解Spring事务传播属性的关键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">* Create a TransactionStatus for an existing transaction.</div><div class="line">*/</div><div class="line">private TransactionStatus handleExistingTransaction(</div><div class="line">              TransactionDefinition definition, Object transaction, boolean debugEnabled)</div><div class="line">              throws TransactionException &#123;</div><div class="line"></div><div class="line">       if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123;</div><div class="line">              throw new IllegalTransactionStateException(</div><div class="line">                            &quot;Existing transaction found for transaction marked with propagation &apos;never&apos;&quot;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123;</div><div class="line">              if (debugEnabled) &#123;</div><div class="line">                     logger.debug(&quot;Suspending current transaction&quot;);</div><div class="line">              &#125;</div><div class="line">              Object suspendedResources = suspend(transaction);</div><div class="line">              boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</div><div class="line">              return prepareTransactionStatus(</div><div class="line">                            definition, null, false, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123;</div><div class="line">              if (debugEnabled) &#123;</div><div class="line">                     logger.debug(&quot;Suspending current transaction, creating new transaction with name [&quot; +</div><div class="line">                                   definition.getName() + &quot;]&quot;);</div><div class="line">              &#125;</div><div class="line">              SuspendedResourcesHolder suspendedResources = suspend(transaction);</div><div class="line">              try &#123;</div><div class="line">                     boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">                     DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">                                   definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">                     doBegin(transaction, definition);</div><div class="line">                     prepareSynchronization(status, definition);</div><div class="line">                     return status;</div><div class="line">              &#125;</div><div class="line">              catch (RuntimeException beginEx) &#123;</div><div class="line">                     resumeAfterBeginException(transaction, suspendedResources, beginEx);</div><div class="line">                     throw beginEx;</div><div class="line">              &#125;</div><div class="line">              catch (Error beginErr) &#123;</div><div class="line">                     resumeAfterBeginException(transaction, suspendedResources, beginErr);</div><div class="line">                     throw beginErr;</div><div class="line">              &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</div><div class="line">              if (!isNestedTransactionAllowed()) &#123;</div><div class="line">                     throw new NestedTransactionNotSupportedException(</div><div class="line">                                   &quot;Transaction manager does not allow nested transactions by default - &quot; +</div><div class="line">                                   &quot;specify &apos;nestedTransactionAllowed&apos; property with value &apos;true&apos;&quot;);</div><div class="line">              &#125;</div><div class="line">              if (debugEnabled) &#123;</div><div class="line">                     logger.debug(&quot;Creating nested transaction with name [&quot; + definition.getName() + &quot;]&quot;);</div><div class="line">              &#125;</div><div class="line">              if (useSavepointForNestedTransaction()) &#123;／／在Spring管理的事务中，创建事务保存点</div><div class="line">                     // Create savepoint within existing Spring-managed transaction,</div><div class="line">                     // through the SavepointManager API implemented by TransactionStatus.</div><div class="line">                     // Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</div><div class="line">                     DefaultTransactionStatus status =</div><div class="line">                                   prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null);</div><div class="line">                     status.createAndHoldSavepoint();</div><div class="line">                     return status;</div><div class="line">              &#125;</div><div class="line">              else &#123;</div><div class="line">                     // Nested transaction through nested begin and commit/rollback calls.</div><div class="line">                     // Usually only for JTA: Spring synchronization might get activated here</div><div class="line">                     // in case of a pre-existing JTA transaction.</div><div class="line">                     boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">                     DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">                                   definition, transaction, true, newSynchronization, debugEnabled, null);</div><div class="line">                     doBegin(transaction, definition);</div><div class="line">                     prepareSynchronization(status, definition);</div><div class="line">                     return status;</div><div class="line">              &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</div><div class="line">       if (debugEnabled) &#123;</div><div class="line">              logger.debug(&quot;Participating in existing transaction&quot;);</div><div class="line">       &#125;</div><div class="line">       if (isValidateExistingTransaction()) &#123;</div><div class="line">              if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123;</div><div class="line">                     Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</div><div class="line">                     if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123;</div><div class="line">                            Constants isoConstants = DefaultTransactionDefinition.constants;</div><div class="line">                            throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</div><div class="line">                                          definition + &quot;] specifies isolation level which is incompatible with existing transaction: &quot; +</div><div class="line">                                          (currentIsolationLevel != null ?</div><div class="line">                                                        isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) :</div><div class="line">                                                        &quot;(unknown)&quot;));</div><div class="line">                     &#125;</div><div class="line">              &#125;</div><div class="line">              if (!definition.isReadOnly()) &#123;</div><div class="line">                     if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123;</div><div class="line">                            throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</div><div class="line">                                          definition + &quot;] is not marked as read-only but existing transaction is&quot;);</div><div class="line">                     &#125;</div><div class="line">              &#125;</div><div class="line">       &#125;</div><div class="line">       boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">       return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="事务挂起"><a href="#事务挂起" class="headerlink" title="事务挂起"></a>事务挂起</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">protected final SuspendedResourcesHolder suspend(Object transaction) throws TransactionException &#123;／／返回的SuspendedResourcesHolder会作为参数传给TransactionStatus</div><div class="line">       if (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</div><div class="line">              List&lt;TransactionSynchronization&gt; suspendedSynchronizations = doSuspendSynchronization();</div><div class="line">              try &#123;</div><div class="line">                     Object suspendedResources = null;／／把挂起事务的处理交给具体事务处理器去完成，如果具体的事务处理器不支持事务挂起，则默认抛出TransactionSuspensionNotSupportedException</div><div class="line">                     if (transaction != null) &#123;</div><div class="line">                            suspendedResources = doSuspend(transaction);</div><div class="line">                     &#125;//这里在线程中保存与事务处理有关的信息，并重置线程中相关的ThreadLocal变量</div><div class="line">                     String name = TransactionSynchronizationManager.getCurrentTransactionName();</div><div class="line">                     TransactionSynchronizationManager.setCurrentTransactionName(null);</div><div class="line">                     boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</div><div class="line">                     TransactionSynchronizationManager.setCurrentTransactionReadOnly(false);</div><div class="line">                     Integer isolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</div><div class="line">                     TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(null);</div><div class="line">                     boolean wasActive = TransactionSynchronizationManager.isActualTransactionActive();</div><div class="line">                     TransactionSynchronizationManager.setActualTransactionActive(false);</div><div class="line">                     return new SuspendedResourcesHolder(</div><div class="line">                                   suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive);</div><div class="line">              &#125;</div><div class="line">              catch (RuntimeException ex) &#123;</div><div class="line">                     // doSuspend failed - original transaction is still active… 如果处理失败，则恢复原始的事务</div><div class="line">                     doResumeSynchronization(suspendedSynchronizations);</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (Error err) &#123;</div><div class="line">                     // doSuspend failed - original transaction is still active...</div><div class="line">                     doResumeSynchronization(suspendedSynchronizations);</div><div class="line">                     throw err;</div><div class="line">              &#125;</div><div class="line">       &#125;</div><div class="line">       else if (transaction != null) &#123;</div><div class="line">              // Transaction active but no synchronization active.</div><div class="line">              Object suspendedResources = doSuspend(transaction);</div><div class="line">              return new SuspendedResourcesHolder(suspendedResources);</div><div class="line">       &#125;</div><div class="line">       else &#123;</div><div class="line">              // Neither transaction nor synchronization active.</div><div class="line">              return null;</div><div class="line">       &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Reactivate transaction synchronization for the current thread</div><div class="line"> * and resume all given synchronizations.</div><div class="line"> * @param suspendedSynchronizations List of TransactionSynchronization objects</div><div class="line"> */doSuspend 失败则恢复事务</div><div class="line">private void doResumeSynchronization(List&lt;TransactionSynchronization&gt; suspendedSynchronizations) &#123;</div><div class="line">       TransactionSynchronizationManager.initSynchronization();／／维护着ThreadLocal变量</div><div class="line">       for (TransactionSynchronization synchronization : suspendedSynchronizations) &#123;</div><div class="line">              synchronization.resume();</div><div class="line">              TransactionSynchronizationManager.registerSynchronization(synchronization);</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="事务的提交"><a href="#事务的提交" class="headerlink" title="事务的提交"></a>事务的提交</h4><p>在声明式事务处理中，事务的提交在TransactionInteceptor的invoke方法中实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">commitTransactionAfterReturning(txInfo)</div></pre></td></tr></table></figure></p>
<p>txInfo是TransactionInfo对象，是创建事务时生成的。同时，Spring的事务管理框架的生成的TransactionStatus对象就包含在TransactionInfo对象中。commitTransactionAfterReturning具体实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">protected void commitTransactionAfterReturning(TransactionAspectSupport.TransactionInfo txInfo) &#123;</div><div class="line">  if(txInfo != null &amp;&amp; txInfo.hasTransaction()) &#123;</div><div class="line">    if(this.logger.isTraceEnabled()) &#123;</div><div class="line">      this.logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用具体的事务管理器实现。而在事务管理器中的实现在AbstractPlatformTransactionManager中存在一个模版：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">* This implementation of commit handles participating in existing</div><div class="line">* transactions and programmatic rollback requests.</div><div class="line">* Delegates to &#123;@code isRollbackOnly&#125;, &#123;@code doCommit&#125;</div><div class="line">* and &#123;@code rollback&#125;.</div><div class="line">* @see org.springframework.transaction.TransactionStatus#isRollbackOnly()</div><div class="line">* @see #doCommit</div><div class="line">* @see #rollback</div><div class="line">*/</div><div class="line">@Override</div><div class="line">public final void commit(TransactionStatus status) throws TransactionException &#123;</div><div class="line">       if (status.isCompleted()) &#123;</div><div class="line">              throw new IllegalTransactionStateException(</div><div class="line">                            &quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;</div><div class="line">       if (defStatus.isLocalRollbackOnly()) &#123;／／如果事务处理过程中发生了异常，调用回滚。</div><div class="line">              if (defStatus.isDebug()) &#123;</div><div class="line">                     logger.debug(&quot;Transactional code has requested rollback&quot;);</div><div class="line">              &#125;</div><div class="line">              processRollback(defStatus);</div><div class="line">              return;</div><div class="line">       &#125;</div><div class="line">       if (!shouldCommitOnGlobalRollbackOnly() &amp;&amp; defStatus.isGlobalRollbackOnly()) &#123;</div><div class="line">              if (defStatus.isDebug()) &#123;</div><div class="line">                     logger.debug(&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;);</div><div class="line">              &#125;／／处理回滚</div><div class="line">              processRollback(defStatus);</div><div class="line">              // Throw UnexpectedRollbackException only at outermost transaction boundary</div><div class="line">              // or if explicitly asked to.</div><div class="line">              if (status.isNewTransaction() || isFailEarlyOnGlobalRollbackOnly()) &#123;</div><div class="line">                     throw new UnexpectedRollbackException(</div><div class="line">                                   &quot;Transaction rolled back because it has been marked as rollback-only&quot;);</div><div class="line">              &#125;</div><div class="line">              return;</div><div class="line">       &#125;</div><div class="line">       ／／处理提交入口</div><div class="line">       processCommit(defStatus);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出rollback和commit都在这个方法中实现。看看 processCommit的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">private void processCommit(DefaultTransactionStatus status) throws TransactionException &#123;</div><div class="line">       try &#123;</div><div class="line">              boolean beforeCompletionInvoked = false;</div><div class="line">              try &#123;／／事务的提交准备工作由具体的事务处理器来完成</div><div class="line">                     prepareForCommit(status);</div><div class="line">                     triggerBeforeCommit(status);</div><div class="line">                     triggerBeforeCompletion(status);</div><div class="line">                     beforeCompletionInvoked = true;</div><div class="line">                     boolean globalRollbackOnly = false;</div><div class="line">                     if (status.isNewTransaction() || isFailEarlyOnGlobalRollbackOnly()) &#123;</div><div class="line">                            globalRollbackOnly = status.isGlobalRollbackOnly();</div><div class="line">                     &#125;／／嵌套事务的处理过程。</div><div class="line">                     if (status.hasSavepoint()) &#123;</div><div class="line">                            if (status.isDebug()) &#123;</div><div class="line">                                   logger.debug(&quot;Releasing transaction savepoint&quot;);</div><div class="line">                            &#125;</div><div class="line">                            status.releaseHeldSavepoint();</div><div class="line">                     &#125;</div><div class="line">                     else if (status.isNewTransaction()) &#123;／／根据当前线程中保存的事务状态进行处理，如果当前的事务是一个新的事务，调用具体事务处理器的完成提交，如果当前所持有的事务不是一个新事务，则不提交，由已经存在的事务来完成提交</div><div class="line">                            if (status.isDebug()) &#123;</div><div class="line">                                   logger.debug(&quot;Initiating transaction commit&quot;);</div><div class="line">                            &#125;</div><div class="line">                            doCommit(status);</div><div class="line">                     &#125;</div><div class="line">                     // Throw UnexpectedRollbackException if we have a global rollback-only</div><div class="line">                     // marker but still didn&apos;t get a corresponding exception from commit.</div><div class="line">                     if (globalRollbackOnly) &#123;</div><div class="line">                            throw new UnexpectedRollbackException(</div><div class="line">                                          &quot;Transaction silently rolled back because it has been marked as rollback-only&quot;);</div><div class="line">                     &#125;</div><div class="line">              &#125;</div><div class="line">              catch (UnexpectedRollbackException ex) &#123;</div><div class="line">                     // can only be caused by doCommit</div><div class="line">                     triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (TransactionException ex) &#123;</div><div class="line">                     // can only be caused by doCommit</div><div class="line">                     if (isRollbackOnCommitFailure()) &#123;</div><div class="line">                            doRollbackOnCommitException(status, ex);</div><div class="line">                     &#125;</div><div class="line">                     else &#123;</div><div class="line">                            triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</div><div class="line">                     &#125;</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (RuntimeException ex) &#123;</div><div class="line">                     if (!beforeCompletionInvoked) &#123;</div><div class="line">                            triggerBeforeCompletion(status);</div><div class="line">                     &#125;</div><div class="line">                     doRollbackOnCommitException(status, ex);</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (Error err) &#123;</div><div class="line">                     if (!beforeCompletionInvoked) &#123;</div><div class="line">                            triggerBeforeCompletion(status);</div><div class="line">                     &#125;</div><div class="line">                     doRollbackOnCommitException(status, err);</div><div class="line">                     throw err;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              // Trigger afterCommit callbacks, with an exception thrown there</div><div class="line">              // propagated to callers but the transaction still considered as committed.</div><div class="line">              try &#123;</div><div class="line">                     triggerAfterCommit(status);</div><div class="line">              &#125;</div><div class="line">              finally &#123;</div><div class="line">                     triggerAfterCompletion(status, TransactionSynchronization.STATUS_COMMITTED);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       finally &#123;</div><div class="line">              cleanupAfterCompletion(status);</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，对事务的提交处理都是紧紧围绕TransactionStatus保存的事务处理相关状态进行判断。具体的提交处理过程都设计成抽象方法，交由具体的事务处理器来完成。</p>
<h4 id="事务的回滚"><a href="#事务的回滚" class="headerlink" title="事务的回滚"></a>事务的回滚</h4><p>在事务的提交方法中看到了事务的回滚入口，即processRollback方法，其实现代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">private void processRollback(DefaultTransactionStatus status) &#123;</div><div class="line">       try &#123;</div><div class="line">              try &#123;</div><div class="line">                     triggerBeforeCompletion(status);</div><div class="line">                     if (status.hasSavepoint()) &#123;／／嵌套事务的回滚处理</div><div class="line">                            if (status.isDebug()) &#123;</div><div class="line">                                   logger.debug(&quot;Rolling back transaction to savepoint&quot;);</div><div class="line">                            &#125;</div><div class="line">                            status.rollbackToHeldSavepoint();</div><div class="line">                     &#125;／／当前事务调用方法中新建事务的回滚处理</div><div class="line">                     else if (status.isNewTransaction()) &#123;</div><div class="line">                            if (status.isDebug()) &#123;</div><div class="line">                                   logger.debug(&quot;Initiating transaction rollback&quot;);</div><div class="line">                            &#125;</div><div class="line">                            doRollback(status);</div><div class="line">                     &#125;／／如果在当前事务调用方法中没有新建事务的回滚处理</div><div class="line">                     else if (status.hasTransaction()) &#123;</div><div class="line">                            if (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123;</div><div class="line">                                   if (status.isDebug()) &#123;</div><div class="line">                                          logger.debug(&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;);</div><div class="line">                                   &#125;</div><div class="line">                                   doSetRollbackOnly(status);</div><div class="line">                            &#125;／／由线程的前一个事务来处理回滚，这里不执行任何操作。</div><div class="line">                            else &#123;</div><div class="line">                                   if (status.isDebug()) &#123;</div><div class="line">                                          logger.debug(&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;);</div><div class="line">                                   &#125;</div><div class="line">                            &#125;</div><div class="line">                     &#125;</div><div class="line">                     else &#123;</div><div class="line">                            logger.debug(&quot;Should roll back transaction but cannot - no transaction available&quot;);</div><div class="line">                     &#125;</div><div class="line">              &#125;</div><div class="line">              catch (RuntimeException ex) &#123;</div><div class="line">                     triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</div><div class="line">                     throw ex;</div><div class="line">              &#125;</div><div class="line">              catch (Error err) &#123;</div><div class="line">                     triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</div><div class="line">                     throw err;</div><div class="line">              &#125;</div><div class="line">              triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</div><div class="line">       &#125;</div><div class="line">       finally &#123;</div><div class="line">              cleanupAfterCompletion(status);</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，看了代码我们很快就能理解，Spring 事务传播属性中的 Required_New和NESTED（嵌套事务）的本质区别</p>
<ol>
<li>PROPAGATION_REQUIRES_NEW 启动一个新的, 不依赖于环境的 “内部” 事务. 这个事务将被完全 commited 或 rolled back 而不依赖于外部事务, 它拥有自己的隔离范围, 自己的锁, 等等. 当内部事务开始执行时, 外部事务将被挂起, 内务事务结束时, 外部事务将继续执行. </li>
<li>另一方面, PROPAGATION_NESTED 开始一个 “嵌套的” 事务,  它是已经存在事务的一个真正的子事务. 潜套事务开始执行时,它将取得一个 savepoint. 如果这个嵌套事务失败,我们将回滚到此savepoint潜套事务是外部事务的一部分,只有外部事务结束后它才会被提交。</li>
<li>由此可见, PROPAGATION_REQUIRES_NEW 和 PROPAGATION_NESTED 的最大区别在于, PROPAGATION_REQUIRES_NEW 完全是一个新的事务, 而 PROPAGATION_NESTED 则是外部事务的子事务, 如果外部事务 commit, 潜套事务也会被 commit, 这个规则同样适用于 roll back. </li>
</ol>
<p>也就是说：</p>
<ol>
<li>PROPAGATION_REQUIRES_NEW事务不受外部事务的影响，是隔离的。</li>
<li>PROPAGATION_NESTED，如果内部事务失败且内部，它会回到savepoint之前的状态不会产生脏数据，而外部事务catch住异常后可以选择回滚或者提交；如果外部事务失败，由于嵌套事务是外部事务的一部分，则会导致外部事务与嵌套事务一起回滚。</li>
</ol>

                <hr>
                
                <!-- 多说 Share start -->
                <div class="ds-share"
                     style="text-align: right"
                     data-thread-key="2017/02/12/Spring源码解析-事务处理/"
                     data-title="Spring源码解析--事务处理"
                     data-url="http://jacobs.wanhb.cn/2017/02/12/Spring源码解析-事务处理/"
                     data-images=""
                     data-content="事务处理相关类的层次结构
在 Spring事务处理中，可以通过设计一个TransactionP... | CHAO LI&#39;s blog ">
                    <div class="ds-share-inline">
                        <ul class="ds-share-icons-16">
                            <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                            <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                            <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                            <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                        </ul>
                        <div class="ds-share-icons-more">
                        </div>
                    </div>
                    <hr>
                </div>
                <!-- 多说 Share end-->
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/02/15/InnoDB读书笔记/" data-toggle="tooltip" data-placement="top"
                           title="InnoDB读书笔记">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/02/07/Spring源码解读/" data-toggle="tooltip" data-placement="top"
                           title="Spring源码解读(-)">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                
                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread"
                         data-thread-key="2017/02/12/Spring源码解析-事务处理/"
                         data-title="Spring源码解析--事务处理"
                         data-url="http://jacobs.wanhb.cn/2017/02/12/Spring源码解析-事务处理/">
                    </div>
                </div>
                <!-- 多说评论框 end -->
                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#事务处理相关类的层次结构"><span class="toc-text">事务处理相关类的层次结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring声明式事务处理"><span class="toc-text">Spring声明式事务处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设计原理与过程"><span class="toc-text">设计原理与过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务处理配置的读入"><span class="toc-text">事务处理配置的读入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务处理拦截器的设计与实现："><span class="toc-text">事务处理拦截器的设计与实现：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring事务处理的设计与实现"><span class="toc-text">Spring事务处理的设计与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring事务传播属性"><span class="toc-text">Spring事务传播属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务的创建"><span class="toc-text">事务的创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务挂起"><span class="toc-text">事务挂起</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务的提交"><span class="toc-text">事务的提交</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务的回滚"><span class="toc-text">事务的回滚</span></a></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#spring"
                           title="spring">spring</a>
                        
                        <a class="tag" href="/tags/#ioc"
                           title="ioc">ioc</a>
                        
                        <a class="tag" href="/tags/#aop"
                           title="aop">aop</a>
                        
                        <a class="tag" href="/tags/#源码"
                           title="源码">源码</a>
                        
                        <a class="tag" href="/tags/#事务处理"
                           title="事务处理">事务处理</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>

    </div>
</article>


<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    // dynamic User by Hux
    var _user = 'jacobs';

    // duoshuo comment query.
    var duoshuoQuery = {short_name: _user};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->





<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/lichaojacobs">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/chao-li-11">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/577448557">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/lichaojacobs">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; CHAO LI 2017
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://jacobs.wanhb.cn/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->



<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','null','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="/images/avatar2.jpeg">
</body>

</html>
