<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 3.7.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>CHAO LI&#39;s Blog</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="CHAO LI&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="CHAO LI&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CHAO LI&#39;s Blog">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    <script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?4ca08f1c48fe3bf3d0e2bfb54473d985";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/hadoop_logo.jpg" alt="CHAO LI&#39;s Blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
                <a class="navbar-item"
                href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-08-30T12:16:45.000Z">2018-08-30</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    21 分钟 读完 (大约 3214 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/08/30/airflow实战总结/">airflow实战总结</a>
            
        </h1>
        <div class="content">
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>airflow是一款开源的，分布式任务调度框架，它将一个具有上下级依赖关系的工作流，组装成一个有向无环图。</p>
<ul>
<li>特点:<ul>
<li>分布式任务调度：允许一个工作流的task在多台worker上同时执行</li>
<li>可构建任务依赖：以有向无环图的方式构建任务依赖关系</li>
<li>task原子性：工作流上每个task都是原子可重试的，一个工作流某个环节的task失败可自动或手动进行重试，不必从头开始任务</li>
</ul>
</li>
<li><p>工作流示意图</p>
<p>  <img src="https://pic4.zhimg.com/v2-fbd8d77be2eda3c9766c300359e8eba3_1200x500.jpg" alt="airflow-dags"></p>
<ul>
<li>一个dag表示一个定时的工作流，包含一个或者多个具有依赖关系的task</li>
</ul>
</li>
<li><p>task依赖图</p>
<p>  <img src="https://pic1.zhimg.com/80/v2-57deb1228a73c290c666539bc56ee8ac_hd.jpg" alt="airflow-tasks"></p>
</li>
<li><p>架构图及集群角色</p>
<p>  <img src="https://pic1.zhimg.com/80/v2-35a160b63e7389fe12f451e299ab0c00_hd.jpg" alt="airflow-infra"></p>
<ul>
<li>webserver : 提供web端服务，以及会定时生成子进程去扫描对应的目录下的dags，并更新数据库</li>
<li>scheduler : 任务调度服务，根据dags生成任务，并提交到消息中间件队列中 (redis或rabbitMq)</li>
<li>celery worker : 分布在不同的机器上，作为任务真正的的执行节点。通过监听消息中间件: redis或rabbitMq 领取任务</li>
<li>flower : 监控worker进程的存活性，启动或关闭worker进程，查看运行的task</li>
</ul>
</li>
</ul>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><ul>
<li><p>构建docker镜像</p>
<ul>
<li><p>采用的airflow是未发行的1.10.0版本，原因是从1.10.0开始，支持时区的设置，而不是统一的UTC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">//self.registry.domain 为docker私有镜像仓库</span><br><span class="line">//self.mvn.registry.com maven 私有镜像仓库</span><br><span class="line">//data0 为数据目录，data1为日志目录，运维统一配置日志清楚策略</span><br><span class="line">#docker build --network host -t self.registry.domain/airflow_base_1.10.7:1.0.0 .</span><br><span class="line">FROM self.registry.domain/airflow/centos_base_7.4.1708:1.0.0</span><br><span class="line">LABEL AIRFLOW=1.10.7</span><br><span class="line"></span><br><span class="line">ARG CELERY_REDIS=4.1.1</span><br><span class="line">ARG DOCKER_VERSION=1.13.1</span><br><span class="line">ARG AIRFLOW_VERSION=1.10.7</span><br><span class="line"></span><br><span class="line">ADD sbin /data0/airflow/sbin</span><br><span class="line"></span><br><span class="line">ENV SLUGIFY_USES_TEXT_UNIDECODE=yes \</span><br><span class="line">    #如果构建镜像的机器需要代理才能连接外网的话，配置https_proxy</span><br><span class="line">    https_proxy=https://ip:port </span><br><span class="line"></span><br><span class="line">RUN curl http://self.mvn.registry.com/python/python-3.5.6.jar -o /tmp/Python-3.5.6.tgz &amp;&amp; \</span><br><span class="line">    curl http://self.mvn.registry.com/airflow/$&#123;AIRFLOW_VERSION&#125;/airflow-$&#123;AIRFLOW_VERSION&#125;.jar -o /tmp/incubator-airflow-$&#123;AIRFLOW_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    curl http:/self.mvn.registry.com/docker/$&#123;DOCKER_VERSION&#125;/docker-$&#123;DOCKER_VERSION&#125;.jar -o /tmp/docker-$&#123;DOCKER_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf /tmp/docker-$&#123;DOCKER_VERSION&#125;.tar.gz -C /data0/software &amp;&amp; \</span><br><span class="line">    tar zxf /tmp/Python-3.5.6.tgz -C /data0/software &amp;&amp; \</span><br><span class="line">    tar zxf /tmp/incubator-airflow-$&#123;AIRFLOW_VERSION&#125;.tar.gz -C /data0/software &amp;&amp; \</span><br><span class="line">    yum install -y libtool-ltdl policycoreutils-python &amp;&amp; \</span><br><span class="line">    rpm -ivh --force --nodeps /data0/software/docker-$&#123;DOCKER_VERSION&#125;/docker-engine-selinux-$&#123;DOCKER_VERSION&#125;-1.el7.centos.noarch.rpm &amp;&amp; \</span><br><span class="line">    rpm -ivh --force --nodeps /data0/software/docker-$&#123;DOCKER_VERSION&#125;/docker-engine-$&#123;DOCKER_VERSION&#125;-1.el7.centos.x86_64.rpm &amp;&amp; \</span><br><span class="line">    yum -y install gcc &amp;&amp; yum -y install gcc-c++ &amp;&amp; yum -y install make &amp;&amp; \</span><br><span class="line">    yum -y install zlib-devel mysql-devel python-devel cyrus-sasl-devel cyrus-sasl-lib libxml2-devel libxslt-devel &amp;&amp; \</span><br><span class="line">    cd /data0/software/Python-3.5.6 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install &amp;&amp; \</span><br><span class="line">    ln -sf /usr/local/bin/pip3 /usr/local/bin/pip &amp;&amp; \</span><br><span class="line">    ln -sf /usr/local/bin/python3 /usr/local/bin/python &amp;&amp; \</span><br><span class="line">    cd /data0/software/incubator-airflow-$&#123;AIRFLOW_VERSION&#125; &amp;&amp; python setup.py install &amp;&amp; \</span><br><span class="line">    pip install -i https://pypi.douban.com/simple/ apache-airflow[crypto,celery,hive,jdbc,mysql,hdfs,password,redis,devel_hadoop] &amp;&amp; \</span><br><span class="line">    pip install -i https://pypi.douban.com/simple/ celery[redis]==$CELERY_REDIS &amp;&amp; \</span><br><span class="line">    pip install -i https://pypi.douban.com/simple/ docutils &amp;&amp; \</span><br><span class="line">    ln -sf /usr/local/lib/python3.5/site-packages/apache_airflow-1.10.0-py3.5.egg/airflow /data0/software/airflow &amp;&amp; \</span><br><span class="line">    mkdir -p /data0/airflow/bin &amp;&amp; \</span><br><span class="line">    ln -sf /data0/airflow/sbin/airflow-200.sh /data0/airflow/bin/200.sh &amp;&amp; \</span><br><span class="line">    ln -sf /data0/airflow/sbin/airflow-503.sh /data0/airflow/bin/503.sh &amp;&amp; \</span><br><span class="line">    chown -R root:root /data0/software/ &amp;&amp; \</span><br><span class="line">    chown -R root:root /data0/airflow/ &amp;&amp; \</span><br><span class="line">    chmod -R 775 /data0/airflow/sbin/* &amp;&amp; \</span><br><span class="line">    chmod -R 775 /data0/airflow/bin/* &amp;&amp; \</span><br><span class="line">    echo &apos;source /data0/airflow/sbin/init-airflow.sh&apos; &gt;&gt; ~/.bashrc &amp;&amp; \</span><br><span class="line">    rm -rf /tmp/* /data0/software/Python-3.5.6 /data0/software/incubator-airflow-$&#123;AIRFLOW_VERSION&#125; /data0/software/docker-$&#123;DOCKER_VERSION&#125;</span><br><span class="line">    </span><br><span class="line">ENV PATH=$PATH:/data0/software/jdk/bin:/data0/software/airflow/bin:/data0/airflow/sbin/:/data0/airflow/sbin/airflow/:/data0/airflow/bin/</span><br><span class="line"></span><br><span class="line">WORKDIR /data0/airflow/bin/</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过docker 启动容器的话需要暴露几个端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">webserver: 8081</span><br><span class="line">worker: 8793</span><br><span class="line">flower: 5555</span><br><span class="line">//启动示例</span><br><span class="line">docker run --name airflow -it -d --privileged --net=host -p 8081:8081 -p 5555:5555 -p 8793:8793 -v /var/run/docker.sock:/var/run/docker.sock -v /data1:/data1 -v /data0/airflow:/data0/airflow self.registry.domain/airflow_1.10.7:1.0.0</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>airflow 升级到未release的1.10.0的版本</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//如果之前用的是低版本的话，需要执行</span><br><span class="line">airflow upgradedb 来更新迁移数据库的schema</span><br><span class="line">//执行之前首先需要set mysql property</span><br><span class="line">set global explicit_defaults_for_timestamp=1 //会提示is readonly variable</span><br><span class="line">需要在my.cnf中添加这个设置:explicit_defaults_for_timestamp=1 并重启mysql</span><br><span class="line">//update celery几个设置</span><br><span class="line">celeryd_concurrency -&gt; worker_concurrency</span><br><span class="line">celery_result_backend -&gt; result_backend</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改时区，以及界面上执行时间的显示(airlfow 默认界面上还是按照UTC显示)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//需要update configuration</span><br><span class="line">default_timezone = Etc/GMT-8</span><br><span class="line"></span><br><span class="line">//修改dags.html中的显示时间，使得界面上看起来方便</span><br><span class="line">// jinjia2 传入转换函数，在views.py 的homeview的render中 </span><br><span class="line">//（方法验证有点问题，再优化）</span><br><span class="line">def utc2local(utc):</span><br><span class="line">    epoch = time.mktime(utc.timetuple())</span><br><span class="line">    offset = datetime.fromtimestamp(epoch) - datetime.utcfromtimestamp(epoch)</span><br><span class="line">    return utc + offset</span><br><span class="line">utc2local(last_run.execution_date).strftime(&quot;%Y-%m-%d %H:%M&quot;)</span><br><span class="line">utc2local(last_run.start_date).strftime(&quot;%Y-%m-%d %H:%M&quot;)`</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>airflow plugins 定制化开发</p>
<ul>
<li><a href="https://airflow.apache.org/plugins.html" target="_blank" rel="noopener">官方文档</a></li>
<li>plugin 这个没法传给worker，还是得重新分发到各个worker节点，建议打入airflow基础镜像中</li>
<li>增加operator时需要重启webserver和scheduler</li>
</ul>
</li>
<li><p>由于dag的删除现在官方没有暴露直接的api,而完整的删除又牵扯到多个表，总结出删除dag的sql如下</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set @dag_id = &apos;BAD_DAG&apos;;</span><br><span class="line">delete from airflow.xcom where dag_id = @dag_id;</span><br><span class="line">delete from airflow.task_instance where dag_id = @dag_id;</span><br><span class="line">delete from airflow.sla_miss where dag_id = @dag_id;</span><br><span class="line">delete from airflow.log where dag_id = @dag_id;</span><br><span class="line">delete from airflow.job where dag_id = @dag_id;</span><br><span class="line">delete from airflow.dag_run where dag_id = @dag_id;</span><br><span class="line">delete from airflow.dag where dag_id = @dag_id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自己实现的200和503脚本，用于集群统一的上下线操作</p>
<ul>
<li><p>200脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -e &quot;\n A tool used for starting airflow services</span><br><span class="line">Usage: 200.sh &#123;webserver|worker|scheduler|flower&#125;</span><br><span class="line">&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PORT=8081</span><br><span class="line">ROLE=webserver</span><br><span class="line">ENV_ARGS=&quot;&quot;</span><br><span class="line">check_alive() &#123;</span><br><span class="line">    PID=`netstat -nlpt | grep $PORT | awk &apos;&#123;print $7&#125;&apos; | awk -F &quot;/&quot; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">    [ -n &quot;$PID&quot; ] &amp;&amp; return 0 || return 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_scheduler_alive() &#123;</span><br><span class="line">    PIDS=`ps -ef | grep &quot;/usr/local/bin/airflow scheduler&quot; | grep &quot;python&quot; | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">    [ -n &quot;$PIDS&quot; ] &amp;&amp; return 0 || return 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_host_ip()&#123;</span><br><span class="line">    local host=$(ifconfig | grep &quot;inet &quot; | grep &quot;\-\-&gt;&quot; | awk &apos;&#123;print $2&#125;&apos; | tail -1)</span><br><span class="line">    if [[ -z &quot;$host&quot; ]]; then</span><br><span class="line">        host=$(ifconfig | grep &quot;inet &quot; | grep &quot;broadcast&quot; | awk &apos;&#123;print $2&#125;&apos; | tail -1)</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;$&#123;host&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_service() &#123;</span><br><span class="line">    if [ $ROLE = &apos;scheduler&apos; ];then</span><br><span class="line">        check_scheduler_alive</span><br><span class="line">    else</span><br><span class="line">        check_alive</span><br><span class="line">    fi</span><br><span class="line">    if [ $? -ne 0 ];then</span><br><span class="line">        nohup airflow $ROLE $ENV_ARGS &gt; $BASE_LOG_DIR/$ROLE/$ROLE.log 2&gt;&amp;1 &amp;</span><br><span class="line">        sleep 5</span><br><span class="line">        if [ $ROLE = &apos;scheduler&apos; ];then</span><br><span class="line">            check_scheduler_alive</span><br><span class="line">        else</span><br><span class="line">            check_alive</span><br><span class="line">        fi</span><br><span class="line">        if [ $? -ne 0 ];then</span><br><span class="line">            echo &quot;service start error&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            echo &quot;service start success&quot;</span><br><span class="line">            exit 0</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo &quot;service alreay started&quot;</span><br><span class="line">        exit 0</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    if [ -z &quot;$&#123;POOL&#125;&quot; ]; then</span><br><span class="line">        echo &quot;the environment variable POOL cannot be empty&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    source /data0/hcp/sbin/init-hcp.sh</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">        webserver)</span><br><span class="line">            echo &quot;starting airflow webserver&quot;</span><br><span class="line">            ROLE=webserver</span><br><span class="line">            PORT=8081</span><br><span class="line">            start_service</span><br><span class="line">            ;;</span><br><span class="line">        worker)</span><br><span class="line">            echo &quot;starting airflow worker&quot;</span><br><span class="line">            ROLE=worker</span><br><span class="line">            PORT=8793</span><br><span class="line">            local host_ip=$(get_host_ip)</span><br><span class="line">            ENV_ARGS=&quot;-cn $&#123;host_ip&#125;@$&#123;host_ip&#125;&quot;</span><br><span class="line">            start_service</span><br><span class="line">            ;;</span><br><span class="line">        flower)</span><br><span class="line">            echo &quot;starting airflow flower&quot;</span><br><span class="line">            ROLE=flower</span><br><span class="line">            PORT=5555</span><br><span class="line">            start_service</span><br><span class="line">            ;;</span><br><span class="line">        scheduler)</span><br><span class="line">            echo &quot;starting airflow scheduler&quot;</span><br><span class="line">            ROLE=scheduler</span><br><span class="line">            start_service</span><br><span class="line">            ;;     </span><br><span class="line">        *)</span><br><span class="line">            usage</span><br><span class="line">            exit 1</span><br><span class="line">    esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>503脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -e &quot;\n A tool used for stop airflow services</span><br><span class="line">Usage: 200.sh &#123;webserver|worker|scheduler|flower&#125;</span><br><span class="line">&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_host_ip()&#123;</span><br><span class="line">    local host=$(ifconfig | grep &quot;inet &quot; | grep &quot;\-\-&gt;&quot; | awk &apos;&#123;print $2&#125;&apos; | tail -1)</span><br><span class="line">    if [[ -z &quot;$host&quot; ]]; then</span><br><span class="line">        host=$(ifconfig | grep &quot;inet &quot; | grep &quot;broadcast&quot; | awk &apos;&#123;print $2&#125;&apos; | tail -1)</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;$&#123;host&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    if [ -z &quot;$&#123;POOL&#125;&quot; ]; then</span><br><span class="line">        echo &quot;the environment variable POOL cannot be empty&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    source /data0/hcp/sbin/init-hcp.sh</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">        webserver)</span><br><span class="line">            echo &quot;stopping airflow webserver&quot;</span><br><span class="line">            cat $AIRFLOW_HOME/airflow-webserver.pid | xargs kill -9</span><br><span class="line">            ;;</span><br><span class="line">        worker)</span><br><span class="line">            echo &quot;stopping airflow worker&quot;</span><br><span class="line">            PORT=8793</span><br><span class="line">            PID=`netstat -nlpt | grep $PORT | awk &apos;&#123;print $7&#125;&apos; | awk -F &quot;/&quot; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">            kill -9 $PID</span><br><span class="line">            local host_ip=$(get_host_ip)</span><br><span class="line">            ps -ef | grep celeryd | grep $&#123;host_ip&#125;@$&#123;host_ip&#125; | awk &apos;&#123;print $2&#125;&apos; | xargs kill -9</span><br><span class="line">            ;;</span><br><span class="line">        flower)</span><br><span class="line">            echo &quot;stopping airflow flower&quot;</span><br><span class="line">            PORT=5555</span><br><span class="line">            PID=`netstat -nlpt | grep $PORT | awk &apos;&#123;print $7&#125;&apos; | awk -F &quot;/&quot; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">            kill -9 $PID</span><br><span class="line">            start_service</span><br><span class="line">            ;;</span><br><span class="line">        scheduler)</span><br><span class="line">            echo &quot;stopping airflow scheduler&quot;</span><br><span class="line">            PID=`ps -ef | grep &quot;/usr/local/bin/airflow scheduler&quot; | grep &quot;python&quot; | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            kill -9 $PID</span><br><span class="line">            ;;     </span><br><span class="line">        *)</span><br><span class="line">            usage</span><br><span class="line">            exit 1</span><br><span class="line">    esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="遇到的坑以及定制化解决方案"><a href="#遇到的坑以及定制化解决方案" class="headerlink" title="遇到的坑以及定制化解决方案"></a>遇到的坑以及定制化解决方案</h2><ul>
<li><p>问题1: airflow worker 角色不能使用根用户启动</p>
<ul>
<li><p>原因：不能用根用户启动的根本原因，在于airflow的worker直接用的celery，而celery 源码中有参数默认不能使用ROOT启动，否则将报错, <a href="http://docs.celeryproject.org/en/latest/_modules/celery/platforms.html" target="_blank" rel="noopener">源码链接</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">C_FORCE_ROOT = os.environ.get(&apos;C_FORCE_ROOT&apos;, False)</span><br><span class="line"></span><br><span class="line">ROOT_DISALLOWED = &quot;&quot;&quot;\</span><br><span class="line">Running a worker with superuser privileges when the</span><br><span class="line">worker accepts messages serialized with pickle is a very bad idea!</span><br><span class="line"></span><br><span class="line">If you really want to continue then you have to set the C_FORCE_ROOT</span><br><span class="line">environment variable (but please think about this before you do).</span><br><span class="line"></span><br><span class="line">User information: uid=&#123;uid&#125; euid=&#123;euid&#125; gid=&#123;gid&#125; egid=&#123;egid&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">ROOT_DISCOURAGED = &quot;&quot;&quot;\</span><br><span class="line">You&apos;re running the worker with superuser privileges: this is</span><br><span class="line">absolutely not recommended!</span><br><span class="line"></span><br><span class="line">Please specify a different user using the --uid option.</span><br><span class="line"></span><br><span class="line">User information: uid=&#123;uid&#125; euid=&#123;euid&#125; gid=&#123;gid&#125; egid=&#123;egid&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案一：修改airlfow源码，在celery_executor.py中强制设置C_FORCE_ROOT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from celery import Celery, platforms </span><br><span class="line">在app = Celery(…)后新增 </span><br><span class="line">platforms.C_FORCE_ROOT = True</span><br><span class="line">重启即可</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案二：在容器初始化环境变量的时候，设置C_FORCE_ROOT参数，以零侵入的方式解决问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#强制celery worker运行采用root模式</span><br><span class="line">export C_FORCE_ROOT=True</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>问题2: docker in docker</p>
<ul>
<li>在dags中以docker方式调度任务时，为了container的轻量话，不做重型的docker pull等操作，我们利用了docker cs架构的设计理念，只需要将宿主机的/var/run/docker.sock文件挂载到容器目录下即可 <a href="http://wangbaiyuan.cn/docker-in-docker.html#prettyPhoto" target="_blank" rel="noopener">docker in docker 资料</a></li>
</ul>
</li>
<li><p>问题3: 由于我们运行airlfow的机器是高配机器切分的虚机，host并非是传统的ip段，多节点执行后无法在master节点上通过worker节点提供的日志服务获取执行日志</p>
<ul>
<li><p>查看celery源码(celery/celery/worker/worker.py)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from celery.utils.nodenames import default_nodename, worker_direct</span><br><span class="line">self.hostname = default_nodename(hostname)</span><br><span class="line">// 查看default_nodename方法</span><br><span class="line">def default_nodename(hostname):</span><br><span class="line">    &quot;&quot;&quot;Return the default nodename for this process.&quot;&quot;&quot;</span><br><span class="line">    name, host = nodesplit(hostname or &apos;&apos;)</span><br><span class="line">    return nodename(name or NODENAME_DEFAULT, host or gethostname())</span><br><span class="line"></span><br><span class="line">//默认在worker.py 的构造方法中没有传入hostname 所以在celery nodenames.py中default_nodename方法里面调用了gethostname</span><br><span class="line">//可以看到gethostname的实现，调用了socket.gethostname，这个直接得到了虚拟机的host</span><br><span class="line">gethostname = memoize(1, Cache=dict)(socket.gethostname)</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案：发现airflow worker的启动命令中其实提供了设置celery host name的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">airflow worker -cn=ip@ip</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>问题4: 多个worker节点进行调度反序列化dag执行的时候，报找不到module的错误</p>
<ul>
<li><p>当时考虑到文件更新的一致性，采用所有worker统一执行master下发的序列化dag的方案，而不依赖worker节点上实际的dag文件，开启这一特性操作如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker节点上： airflow worker -cn=ip@ip -p //-p为开关参数，意思是以master序列化的dag作为执行文件，而不是本地dag目录中的文件</span><br><span class="line">master节点上： airflow scheduler -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>错误原因在于远程的worker节点上不存在实际的dag文件，反序列化的时候对于当时在dag中定义的函数或对象找不到module_name</p>
</li>
<li>解决方案一：在所有的worker节点上同时发布dags目录，缺点是dags一致性成问题</li>
<li><p>解决方案二：修改源码中序列化与反序列化的逻辑，主体思路还是替换掉不存在的module为main。修改如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//models.py 文件，对 class DagPickle(Base) 定义修改</span><br><span class="line">import dill</span><br><span class="line">class DagPickle(Base):</span><br><span class="line">id = Column(Integer, primary_key=True)</span><br><span class="line"># 修改前: pickle = Column(PickleType(pickler=dill))</span><br><span class="line">pickle = Column(LargeBinary)</span><br><span class="line">created_dttm = Column(UtcDateTime, default=timezone.utcnow)</span><br><span class="line">pickle_hash = Column(Text)</span><br><span class="line"></span><br><span class="line">__tablename__ = &quot;dag_pickle&quot;</span><br><span class="line">def __init__(self, dag):</span><br><span class="line">    self.dag_id = dag.dag_id</span><br><span class="line">    if hasattr(dag, &apos;template_env&apos;):</span><br><span class="line">        dag.template_env = None</span><br><span class="line">    self.pickle_hash = hash(dag)</span><br><span class="line">    raw = dill.dumps(dag)</span><br><span class="line">    # 修改前: self.pickle = dag</span><br><span class="line">    reg_str = &apos;unusual_prefix_\w*&#123;0&#125;&apos;.format(dag.dag_id)</span><br><span class="line">    result = re.sub(str.encode(reg_str), b&apos;__main__&apos;, raw)</span><br><span class="line">    self.pickle =result</span><br><span class="line"></span><br><span class="line">//cli.py 文件反序列化逻辑 run(args, dag=None) 函数</span><br><span class="line">// 直接通过dill来反序列化二进制文件，而不是通过PickleType 的result_processor做中转</span><br><span class="line">修改前: dag = dag_pickle.pickle</span><br><span class="line">修改后：dag = dill.loads(dag_pickle.pickle)</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案三：源码零侵入，使用python的types.FunctionType重新创建一个不带module的function，这样序列化与反序列化的时候不会有问题（待验证)</p>
<ul>
<li>注意，使用types.FunctionType的方式装饰函数时，由于所有的引用都会从golbals里面找，所以对于module的导入，建议在被装饰的函数里面变成local的方式引入</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//这里把globals()传入是为了把builtlins等一些模块传入，省事</span><br><span class="line">new_func = types.FunctionType((lambda df: df.iloc[:, 0].size == xx).__code__, globals())</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>问题5：由于airflow在master查看task执行日志是通过各个节点的http服务获取的，但是存入task_instance表中的host_name不是ip，可见获取hostname的方式有问题.</p>
<ul>
<li><p>解决方案：修改airflow/utils/net.py 中get_hostname函数，添加优先获取环境变量中设置的hostname的逻辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//models.py TaskInstance</span><br><span class="line">self.hostname = get_hostname()</span><br><span class="line">//net.py 在get_hostname里面加入一个获取环境变量的逻辑</span><br><span class="line">import os</span><br><span class="line">def get_hostname():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Fetch the hostname using the callable from the config or using</span><br><span class="line">    `socket.getfqdn` as a fallback.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # 尝试获取环境变量</span><br><span class="line">    if &apos;AIRFLOW_HOST_NAME&apos; in os.environ:</span><br><span class="line">        return os.environ[&apos;AIRFLOW_HOST_NAME&apos;]</span><br><span class="line">    # First we attempt to fetch the callable path from the config.</span><br><span class="line">    try:</span><br><span class="line">        callable_path = conf.get(&apos;core&apos;, &apos;hostname_callable&apos;)</span><br><span class="line">    except AirflowConfigException:</span><br><span class="line">        callable_path = None</span><br><span class="line"></span><br><span class="line">    # Then we handle the case when the config is missing or empty. This is the</span><br><span class="line">    # default behavior.</span><br><span class="line">    if not callable_path:</span><br><span class="line">        return socket.getfqdn()</span><br><span class="line"></span><br><span class="line">    # Since we have a callable path, we try to import and run it next.</span><br><span class="line">    module_path, attr_name = callable_path.split(&apos;:&apos;)</span><br><span class="line">    module = importlib.import_module(module_path)</span><br><span class="line">    callable = getattr(module, attr_name)</span><br><span class="line">    return callable()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-08-12T12:17:45.000Z">2018-08-12</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1465 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/08/12/impala集群搭建/">impala集群搭建</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>说起Impala，很多人都不会陌生。它区别于MapReduce 中间结果溢写，跨节点数据获取的低效，采用MPP 查询引擎，各查询节点并发执行查询语句，并将生成的查询结果汇总输出。<br>近期开始真正的使用impala，之前只是小玩过已经集成好的环境，并没有真正的从0到1的去构建Impala集群。基于我司所有的大数据组件都是采用容器的方式部署以便统一管理，我们需要先构建Impala镜像</p>
<h2 id="impala-相关介绍"><a href="#impala-相关介绍" class="headerlink" title="impala 相关介绍"></a>impala 相关介绍</h2><ul>
<li>impala是由cloudera公司主导开发的一款大数据实时查询的分析工具，区别于Hive底层传统的MapReduce批处理方式，采用MPP查询引擎架构，相比于Hive 能带来查询性能30-90倍的提升</li>
<li><p>特点</p>
<ul>
<li>查询速度快: 底层MPP查询引擎。基于内存计算，中间结果不写入磁盘，由coordinator汇总数据结果</li>
<li>灵活性高：可以兼容存储在HDFS上的原生数据，也可以兼容优化处理过的压缩数据，与Hive共用metastore兼容从Hive上导入的所有sql语句</li>
<li>可伸缩性：可以很好的和一些BI工具去配合使用，如Microstrategy、Tableau、Qlikview等。</li>
</ul>
</li>
<li><p>架构</p>
</li>
</ul>
<p><img src="http://jacobs.wanhb.cn/images/impala-architecture.png" alt="impala-architecture"></p>
<ul>
<li><p>集群角色</p>
<ul>
<li><p>impalad(query planner,coordinator, exec engine)：</p>
<ul>
<li>分布在datanode节点上，接受客户端的查询请求</li>
<li>接收查询请求的impalad 会作为本次查询的coordinator，生成查询计划树，并分发给具有相应数据的impalad执行</li>
<li>汇总各个impalad上执行的查询结果，返回给客户端</li>
</ul>
</li>
<li>statestore<ul>
<li>跟踪集群中impalad的健康状态及信息位置，并把健康状况同步到所有的impalad进程节点</li>
</ul>
</li>
<li>catalog<ul>
<li>将元数据的变化通知给集群的各个节点，减少refresh和invalidate metadata语句使用</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="镜像构建篇"><a href="#镜像构建篇" class="headerlink" title="镜像构建篇"></a>镜像构建篇</h2><h3 id="hive镜像构建"><a href="#hive镜像构建" class="headerlink" title="hive镜像构建"></a>hive镜像构建</h3><ul>
<li>因为Impala依赖hive metastore，所以在构建impala镜像之前，先要构建hive镜像</li>
<li><p>构建过程</p>
<ul>
<li>impala 不支持 hive 2.x以上的系列，于是选择1.1.0版本，在cloudera官网下载编译好的tarball</li>
<li>原本的hive lib 中缺少连接metastore的mysql jdbc驱动，自己下载jdbc connector jar放入lib目录下即可</li>
<li>由于我hive 用的cdh的版本，而hadoop用的是apache的版本，导致真正运行hive的时候会找不到mapreduce指定的类，为此lib目录下需加入hadoop-core-2.6.0-mr1-cdh5.9.1.jar</li>
<li><p>使用自带的schematool 创建元数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./schematool -initSchema -dbType mysql</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="impala镜像构建"><a href="#impala镜像构建" class="headerlink" title="impala镜像构建"></a>impala镜像构建</h3><ul>
<li>impala 我使用的是2.12.0的版本，这个版本cloudera官方没有提供tarball文件，只提供的rpm包。考虑到自身编译impala 成本比较大，于是采用rpm 安装的方法</li>
<li>详细的安装流程参考链接 <a href="http://lxw1234.com/archives/2017/06/862.htm" target="_blank" rel="noopener">Impala安装配置–RPM方式</a> 我这边只记录一下安装过程中遇到的坑</li>
<li><p>坑一：跟hive一样，由于我使用的hadoop是apache开源版本，有些class对应的包中没有</p>
<ul>
<li>软链hadoop-core-2.6.0-mr1-cdh5.9.1.jar到impala/lib中</li>
<li><p>需要对服务的启动文件catalogd, impalad, stastored改动</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for JAR_FILE in $&#123;IMPALA_HOME&#125;/lib/*.jar; do</span><br><span class="line"> 			export CLASSPATH=&quot;$&#123;JAR_FILE&#125;:$&#123;CLASSPATH&#125;&quot;</span><br><span class="line">done</span><br><span class="line">#hadoop share lib</span><br><span class="line">for HADOOP_JAR_FILE in $HADOOP_HOME/share/hadoop/tools/lib/*.jar; do</span><br><span class="line"> 			export CLASSPATH=&quot;$&#123;HADOOP_JAR_FILE&#125;:$&#123;CLASSPATH&#125;&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>坑二：软链jdbc driver到impala/lib 并修改catalogd，其他启动文件相应都要修改</p>
</li>
<li><p>坑三：启动catalogd,impala-server时报错</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">		E0804 16:42:09.008862   543 MetaStoreUtils.java:1274] Got exception: java.io.IOException No FileSystem for scheme: hdfs</span><br><span class="line">Java exception follows:</span><br><span class="line">		java.io.IOException: No FileSystem for scheme: hdfs</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>    core-site.xml中加入配置

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">   		&lt;name&gt;fs.file.impl&lt;/name&gt;</span><br><span class="line">   		&lt;value&gt;org.apache.hadoop.fs.LocalFileSystem&lt;/value&gt;</span><br><span class="line">   		&lt;description&gt;The FileSystem for file: uris.&lt;/description&gt;</span><br><span class="line"> 		&lt;/property&gt;</span><br><span class="line"> 		&lt;property&gt;</span><br><span class="line">   		&lt;name&gt;fs.hdfs.impl&lt;/name&gt;</span><br><span class="line">   		&lt;value&gt;org.apache.hadoop.hdfs.DistributedFileSystem&lt;/value&gt;</span><br><span class="line">   		&lt;description&gt;The FileSystem for hdfs: uris.&lt;/description&gt;</span><br><span class="line"> 		&lt;/property&gt;</span><br></pre></td></tr></table></figure>


- 坑四 (class org.apache.hdfs.DistributedFileSystem not found)：

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在hadoop2.8.3的版本中org.apache.hadoop.hdfs.DistributedFileSystem can be found in hadoop-hdfs-client jar. </span><br><span class="line">只需要将包引入impala/lib 目录下即可</span><br></pre></td></tr></table></figure>


- 坑五：HBase client各种依赖包没有

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">		ln -s $HBASE_HOME/lib/hbase-shaded-miscellaneous-2.1.0.jar hbase-shaded-miscellaneous.jar</span><br><span class="line">		ln -s $HBASE_HOME/lib/hbase-shaded-protobuf-2.1.0.jar hbase-shaded-protobuf.jar</span><br><span class="line">		ln -s $HBASE_HOME/lib/commons-lang3-3.6.jar commons-lang3.jar</span><br><span class="line">以</span><br></pre></td></tr></table></figure>


- 坑六: 启动impala-server提示sasl plugin not found

    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install cyrus-sasl* </span><br><span class="line">restart impala service</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="impala-集群搭建"><a href="#impala-集群搭建" class="headerlink" title="impala 集群搭建"></a>impala 集群搭建</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><ul>
<li>20 个 impalad服务 与datanode混部，以最大化利用分布式本地查询的优势</li>
<li>catalog, statestore 与namenode节点混部以减少namenode网络IO带来的影响</li>
<li>全部服务部署docker化，脚本化，提供200与503脚本以便统一批量操作服务启动终止</li>
<li><p>200启动脚本是对impala提供的原生的启动命令的封装，包括监听运行进程的存活，便于对集群机器批量操作</p>
</li>
<li><p>200脚本封装代码</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">EXEC_FILE=/impala/impala-server</span><br><span class="line">PROGRESS=/usr/lib/impala/bin/impalad</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -e &quot;\n A tool used for starting impala services</span><br><span class="line">Usage: 200.sh &#123;statestore|catalog|server&#125;</span><br><span class="line">&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_alive() &#123;</span><br><span class="line">    PID=`ps -ef | grep $IMPALA_USER_NAME | grep &quot;$PROGRESS&quot; | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">    [ -n &quot;$PID&quot; ] &amp;&amp; return 0 || return 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_service() &#123;</span><br><span class="line">    if [ ! -f $EXEC_FILE ];then</span><br><span class="line">        echo &quot;file not exists&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    check_alive</span><br><span class="line">    if [ $? -ne 0 ];then</span><br><span class="line">        $EXEC_FILE restart</span><br><span class="line">        sleep 10</span><br><span class="line">        check_alive</span><br><span class="line">        if [ $? -ne 0 ];then</span><br><span class="line">            echo &quot;service start error&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            echo &quot;service start success&quot;</span><br><span class="line">            exit 0</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo &quot;service alreay started&quot;</span><br><span class="line">        exit 0</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    # $SERVICE_POOL是对应的服务池，通过docker run -e 参数传入</span><br><span class="line">    [[ -f /data0/hcp/conf/pools/$&#123;SERVICE_POOL&#125;/init-env.sh ]] &amp;&amp; source /data0/hcp/conf/pools/$&#123;HCP_POOL&#125;/init-env.sh</span><br><span class="line">    [[ -f /data0/hcp/sbin/impala/init-impala.sh ]] &amp;&amp; source /data0/hcp/sbin/impala/init-impala.sh</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">    	statestore)</span><br><span class="line">            echo &quot;starting impala statestore&quot;</span><br><span class="line">    	    EXEC_FILE=/data0/hcp/sbin/impala/impala-state-store</span><br><span class="line">            PROGRESS=/usr/lib/impala/sbin/statestored</span><br><span class="line">            start_service</span><br><span class="line">    	    ;;</span><br><span class="line">        server)</span><br><span class="line">            echo &quot;starting impala server&quot;</span><br><span class="line">            EXEC_FILE=/data0/hcp/sbin/impala/impala-server</span><br><span class="line">            PROGRESS=/usr/lib/impala/sbin/impalad</span><br><span class="line">            start_service</span><br><span class="line">    	    ;;</span><br><span class="line">        catalog)</span><br><span class="line">            echo &quot;starting impala catalog&quot;</span><br><span class="line">            EXEC_FILE=/data0/hcp/sbin/impala/impala-catalog</span><br><span class="line">            PROGRESS=/usr/lib/impala/sbin/catalogd</span><br><span class="line">            start_service</span><br><span class="line">    	    ;;            </span><br><span class="line">        *)</span><br><span class="line">            usage</span><br><span class="line">            exit 1</span><br><span class="line">    esac</span><br><span class="line">&#125;</span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>503脚本设计思路类似</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-04-24T04:40:32.000Z">2018-04-24</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1097 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/04/24/okhttp-support-100-continue-for-palo/">okhttp support 100-continue for palo</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然百度的Palo是个很强大的，基于MPP Search Engine的OLAP框架，但是由于处于开源的早期阶段，各方面都不是很完善。其中，Palo集群的稳定性对于日渐依赖Palo的核心的业务来说显得尤为重要。最近也一直在做Palo稳定性建设相关的工作。在对全链路监控这块，自然而然地想到对业务中使用频繁的http-mini-load接口进行SDK封装，以实现对请求进行失败重试以及失败率的监控报警的功能。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><ul>
<li><p>在实际的SDK封装中，用到了流行的okhttp，发送请求如下:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PaloHttpUtil paloHttpUtil = PaloHttpUtil.builder().build();</span><br><span class="line">String bodyStr = &quot;1 1 2018-04-12 20:13:00 4101628087476389 1\n1 1 2018-04-12 20:13:00 4205819141030267 2&quot;;</span><br><span class="line">System.out.println(paloHttpUtil</span><br><span class="line">        .put(String.format(&quot;http://xxxx:8030/api/feed/comment_trend/_load?&quot; +</span><br><span class="line">                &quot;label=comment_trend_load_%s&amp;columns=trend_type,user_type,timestamp,mid,count&quot;, prefix))</span><br><span class="line">        .auth(&quot;feed&quot;, &quot;feed&quot;)</span><br><span class="line">        .header(&quot;Expect&quot;, &quot;100-continue&quot;)</span><br><span class="line">        .body(bodyStr, ContentType.WILDCARD)</span><br><span class="line">        .asyncSend(3, 10000, TimeUnit.MILLISECONDS)</span><br><span class="line">        .string()</span><br></pre></td></tr></table></figure>
<p>  response: code 307 Temporary {“Status”:”Failed”} 也就是说发生了重定向。对于服务器为何不在一个request中直接接收PUT的数据，这块贴一下100-continue的定义。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">	100 (Continue/继续) :如果服务器收到头信息中带有100-continue的请求，这是指客户端询问是否可以在后续的请求中发送附件。</span><br><span class="line">在这种情况下，服务器用100(SC_CONTINUE)允许客户端继续或用417 (Expectation Failed)告诉客户端不同意接受附件。这个状态码是 HTTP 1.1中新加入的。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>至于为什么发生了重定向先不考虑，先研究一下为什么okhttp不支持307重定向。
</code></pre><h4 id="源码追踪"><a href="#源码追踪" class="headerlink" title="源码追踪"></a>源码追踪</h4><ul>
<li>我们通过debug深入源码看看在哪一步处理的307重定向</li>
</ul>
<p><img src="https://pic2.zhimg.com/80/v2-9dca7e4ac92cae2de9844b1cf5565825_hd.jpg" alt=""></p>
<p>由图，我们可以看到对于request/response的处理，okhttp采取了插件的形式，类似于Spring AOP 源码中切面invoke方法的处理方式。这种插件的方式意味着我们可以定制化请求处理逻辑。借官方原图：</p>
<p><img src="https://pic2.zhimg.com/80/v2-c66ef8de0a698b2b2a7eb99856790ea1_hd.jpg" alt=""></p>
<ul>
<li><p>由于interceptor里面是可以执行重试逻辑或直接返回response，所以，我们再深入看看在哪个Interceptor里直接返回了response。断点打到RetryAndFollowUpInterceptor里如下的代码块：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Request followUp = this.followUpRequest(response, streamAllocation.route());</span><br><span class="line">				//这里followUP返回null</span><br><span class="line">           if (followUp == null) &#123;</span><br><span class="line">               if (!this.forWebSocket) &#123;</span><br><span class="line">                   streamAllocation.release();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               return response;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>  由于followUp返回了null，导致response直接返回。说明当前的redirect策略不支持307重定向，再深入具体的重定向策略followUpRequest</p>
<p>  <img src="https://pic2.zhimg.com/80/v2-f1c8c432fbd725b19055ef3dcf8228a1_hd.jpg" alt=""></p>
<p>  发现307，308如果request method不等于GET且不为HEAD时直接返回了null，由此对于307 的PUT重定向操作okhttp是不支持的</p>
</li>
</ul>
<h2 id="问题的解决"><a href="#问题的解决" class="headerlink" title="问题的解决"></a>问题的解决</h2><h4 id="okhttp-添加自定义redirect-interceptor"><a href="#okhttp-添加自定义redirect-interceptor" class="headerlink" title="okhttp 添加自定义redirect interceptor"></a>okhttp 添加自定义redirect interceptor</h4><ul>
<li><p>前面提到，我们可以往okhttpClient里面添加自定义的interceptor来达到对request/response灵活劫持的目的。于是考虑加一个支持palo put 307 重定向的redirect interceptor.</p>
</li>
<li><p>大致的策略还是跟RetryAndFollowUpInterceptor一样，对followUpRequest的方法做了修改</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">case 300:</span><br><span class="line">  case 301:</span><br><span class="line">case 302:</span><br><span class="line">case 303:</span><br><span class="line">case 307:</span><br></pre></td></tr></table></figure>
<p>  将307放到了300-303并列的位置，进入redirect逻辑。去掉将method统一替换成GET的逻辑:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (HttpMethod.redirectsToGet(method)) &#123;</span><br><span class="line">	requestBuilder.method(&quot;GET&quot;, (RequestBody)null);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	RequestBody requestBody = maintainBody ?userResponse.request().body() : null;</span><br><span class="line">	requestBuilder.method(method, requestBody);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  改为:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">boolean maintainBody = HttpMethod.requiresRequestBody(method);</span><br><span class="line">                                   RequestBody requestBody = maintainBody ? userResponse.request().body() : null;</span><br><span class="line">                                   requestBuilder.method(method, requestBody);</span><br></pre></td></tr></table></figure>
<p>  为了带上用户名密码，去掉逻辑:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> if (!this.sameConnection(userResponse, url))&#123;</span><br><span class="line"> 	requestBuilder.removeHeader(&quot;Authorization&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>至此，Palo http-mini-load put 307 Temporary 重定向问题得到了解决</li>
</ul>
<h4 id="使用apache-httpcomponents"><a href="#使用apache-httpcomponents" class="headerlink" title="使用apache httpcomponents"></a>使用apache httpcomponents</h4><ul>
<li><p>在apache httpcomponents中，可以设置redirectStrategy，来达到重定向的策略，且不受http code的约束</p>
<p>  <img src="https://pic1.zhimg.com/80/v2-4f64e67306feb76dcc66ffea25931da8_hd.jpg" alt=""></p>
<p>  可以看到本身的redirect机制还是比较强大的</p>
</li>
<li><p>不过鉴于本人习惯用okhttp，且用自定义的interceptro也能解决问题，所以暂时没有采用这种方法。</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>okhttp 不支持307除get意外其他request method重定向的原因不得而知。不过对于开源的组件，也不必要满足各种各样奇怪的胃口，对于需求的定制化留好可扩展接口就行。</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-03-26T12:29:18.000Z">2018-03-26</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 8722 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/03/26/JVM知识总结/">JVM知识总结</a>
            
        </h1>
        <div class="content">
            <h2 id="HotSpot-JVM-Architecture"><a href="#HotSpot-JVM-Architecture" class="headerlink" title="HotSpot JVM Architecture"></a>HotSpot JVM Architecture</h2><p><img src="http://jacobs.wanhb.cn/images/hotspotjvm-1.png" alt="HotSpot JVM Architecture"></p>
<h2 id="JVM运行时数据区域"><a href="#JVM运行时数据区域" class="headerlink" title="JVM运行时数据区域"></a>JVM运行时数据区域</h2><ul>
<li>程序计数器 (program counter registers)</li>
<li>java虚拟机栈：线程私有，生命周期与线程相同。每个方法在运行期间都会创建一个栈帧用于存储局部变量、操作数栈、动态链接、方法出口等信息。<ul>
<li>经常有人把java内存区分为堆内存和栈内存，这种分法比较粗糙。其中所指的栈就是虚拟机栈。或者说是虚拟机栈中局部变量表部分。</li>
<li>局部变量表存放了编译期间可知的各种基本数据类型(boolean byte char,…)、对象引用和returnAddress类型</li>
</ul>
</li>
<li>本地方法栈 为虚拟机提供Native方法服务</li>
<li>java堆： 是JVM所管理的内存中最大的一块。是被所有线程共享的一块内存区域。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配（随着JIT编译器的发展与逃逸分析技术的成熟，栈上分配、标量替换优化技术将会导致一些微妙的变化，导致在堆上分配对象不是那么绝对）。</li>
<li><p>方法区： 与Java堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。虽然java虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫做Non-Heap（非堆），目的应该是与Java堆区分开来。</p>
<ul>
<li>对于HotSpot熟悉的人员来说，很多人更愿意把方法区称为“永久代”本质上并不等价，仅仅是因为HotSpot虚拟机设计团队选择把GC分代收集扩展到方法区，或者说使用永久代来实现方法区而已。但是这种实现方式更容易遇到内存溢出的问题，现在HotSpot虚拟机也放弃永久代逐步改为采用Native Memory来实现方法区的规划了（如：把原本放在永久代的字符串常量池移除）</li>
<li>JVM规范对方法区限制非常宽松，但也不是永久存在，还是会存在类的卸载，常量池的回收问题</li>
</ul>
</li>
<li><p>运行时常量池：方法区的一部分，Class文件中出了有类的版本、字段、方法、接口等描述信息外，还有常量池，用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。</p>
<ul>
<li>运行期间也可以将新的常量放入池中，如String类的intern()方法（目前被废除）</li>
</ul>
</li>
<li><p>直接内存(Direct Memory)：不是JVM规范定义的内存区域，但是也被频繁使用，而且也可能导致内存溢出异常。在JDK1.4新加入了NIO 类，引入了一种基于通道与缓冲区Buffer的IO方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆中的DirectByteBuffer对象作为这块内存的引用进行操作。显然，这部分内存不会受到Java堆大小的限制，但是还是受到本机总内存的限制</p>
</li>
</ul>
<h2 id="对象创建"><a href="#对象创建" class="headerlink" title="对象创建"></a>对象创建</h2><h3 id="分配实例内存的时候可能会出现并发问题的解决方案："><a href="#分配实例内存的时候可能会出现并发问题的解决方案：" class="headerlink" title="分配实例内存的时候可能会出现并发问题的解决方案："></a>分配实例内存的时候可能会出现并发问题的解决方案：</h3><ul>
<li>对分配内存空间的动作进行同步处理———实际上JVM采用CAS配上失败重试的方式保证更新操作的原子性</li>
<li>把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在Java堆中预先分配一小块内存称为本地线程分配缓冲（TLAB）。哪个线程要分配内存就在哪个TLAB上分配，只有TLAB用完并分配新的的时候才需要同步锁定。虚拟机是否使用TLAB，可以通过-XX：+／-UseTLAB参数来设定</li>
</ul>
<h3 id="GC-算法："><a href="#GC-算法：" class="headerlink" title="GC 算法："></a>GC 算法：</h3><ul>
<li>可达性分析算法（不算GC算法，仅仅是思想）:</li>
<li>GC Roots的对象包括下面几种：<ul>
<li>1、虚拟机栈（栈帧中的本地变量表）中引用的对象</li>
<li>2、方法区中类静态属性引用的对象</li>
<li>3、方法区中常量引用的对象</li>
<li>4、本地方法栈中JNI（即一般说的Native方法）引用的对象。</li>
</ul>
</li>
</ul>
<ul>
<li>引用计数法：</li>
<li>标记清除（Mark-Sweep)：</li>
<li>复制算法 (Copying)</li>
<li>标记-压缩算法 (Mark-Compact)</li>
<li>增量算法 (Incremental Collecting)</li>
</ul>
<h3 id="JVM-垃圾回收器分类"><a href="#JVM-垃圾回收器分类" class="headerlink" title="JVM 垃圾回收器分类"></a>JVM 垃圾回收器分类</h3><ul>
<li>Young generation:<ul>
<li>Serial</li>
<li>ParNew</li>
<li>Parallel Scavenge</li>
</ul>
</li>
<li>Tenured generation:<ul>
<li>CMS</li>
<li>Parallel Old</li>
<li>Serial Old</li>
</ul>
</li>
<li><p>All</p>
<ul>
<li>G1</li>
</ul>
</li>
<li><p>新生代串行收集器（GC日志中:Default New Generation）： 第一，它仅仅使用单线程进行垃圾回收；第二，它独占式的垃圾回收。复制算法</p>
</li>
<li>老年代串行收集器： 标记-压缩算法。</li>
<li>-XX:+UseParNewGC 参数设置，表示新生代使用并行收集器，老年代使用串行收集器</li>
<li>-XX:+UseParallelGC 参数设置，表示新生代和老年代均使用并行回收收集器</li>
<li>新生代并行回收 (Parallel Scavenge) 收集器，对应的GC日志中新生代的名称为PSYoungGen</li>
<li>老年代并行回收收集器</li>
<li><p>CMS 收集器: 它使用的是标记-清除算法，同时它又是一个使用多线程并发回收的垃圾收集器。</p>
<ul>
<li>主要步骤有：初始标记、并发标记、重新标记、并发清除和并发重置。其中初始标记和重新标记是独占系统资源的，而并发标记、并发清除和并发重置是可以和用户线程一起执行的。因此，从整体上来说，CMS 收集不是独占式的，它可以在应用程序运行过程中进行垃圾回收。</li>
<li>标记-清除算法将会造成大量内存碎片，离散的可用空间无法分配较大的对象。在这种情况下，即使堆内存仍然有较大的剩余空间，也可能会被迫进行一次垃圾回收，以换取一块可用的连续内存，这种现象对系统性能是相当不利的，为了解决这个问题，CMS 收集器还提供了几个用于内存压缩整理的算法。</li>
<li>-XX:+UseCMSCompactAtFullCollection 参数可以使 CMS 在垃圾收集完成后，进行一次内存碎片整理。内存碎片的整理并不是并发进行的。</li>
<li><p>-XX:CMSFullGCsBeforeCompaction 参数可以用于设定进行多少次 CMS 回收后，进行一次内存压缩。使用CMS收集器后，默认新老年代分别使用ParNew和CMS收集器进行垃圾回收</p>
</li>
<li><p>G1 收集器 (Garbage First) : 与 CMS 收集器相比，G1 收集器是基于标记-压缩算法的</p>
<ul>
<li>G1 收集器还可以进行非常精确的停顿控制。它可以让开发人员指定当停顿时长为 M 时，垃圾回收时间不超过 N。</li>
<li>使用参数-XX:+UnlockExperimentalVMOptions –XX:+UseG1GC 来启用 G1 回收器，设置 G1 回收器的目标停顿时间：-XX:MaxGCPauseMills=20,-XX:GCPauseIntervalMills=200。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="JVM内存分配情况"><a href="#JVM内存分配情况" class="headerlink" title="JVM内存分配情况"></a>JVM内存分配情况</h3><ul>
<li><a href="http://trustmeiamadeveloper.com/2016/03/18/where-is-my-memory-java/" target="_blank" rel="noopener">参考链接</a></li>
<li>容器内存 = 文件缓存 + Java 应用内存<br>Java 应用内存 = 堆内存 + MetaSpace + 堆外内存<br>堆外内存 = 线程栈 + 缓冲区（例如 NIO）等等</li>
<li>所以按照目前的经验来看，堆内存至少应该小于 2/3 的容器内存（？）</li>
</ul>
<h3 id="happens-before规则"><a href="#happens-before规则" class="headerlink" title="happens-before规则"></a>happens-before规则</h3><ul>
<li>定义<ul>
<li>如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。</li>
<li>两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么这种重排序并不非法（也就是说，JMM允许这种重排序）</li>
</ul>
</li>
<li>程序顺序规则：一个线程中的每个操作，happens-before于该线程中的任意后续操作。</li>
<li>监视器锁规则：对一个锁的解锁，happens-before于随后对这个锁的加锁。</li>
<li>volatile变量规则：对一个volatile域的写，happens-before于任意后续对这个volatile域的读。</li>
<li>传递性：如果A happens-before B，且B happens-before C，那么A happens-before C。</li>
<li>start()规则：如果线程A执行操作ThreadB.start()（启动线程B），那么A线程的ThreadB.start()操作happens-before于线程B中的任意操作。</li>
<li>join()规则：如果线程A执行操作ThreadB.join()并成功返回，那么线程B中的任意操作happens-before于线程A从ThreadB.join()操作成功返回。</li>
<li>程序中断规则：对线程interrupted()方法的调用先行于被中断线程的代码检测到中断时间的发生。</li>
<li>对象finalize规则：一个对象的初始化完成（构造函数执行结束）先行于发生它的finalize()方法的开始。</li>
</ul>
<h3 id="对象转入老年代的情况："><a href="#对象转入老年代的情况：" class="headerlink" title="对象转入老年代的情况："></a>对象转入老年代的情况：</h3><ul>
<li>1、经过了正常的MinoGC过程数次之后（可以通过-XX:MaxTenuringThreshold配置）晋升到老年代</li>
<li>2、大于一定值的对象直接进入老年代（ 通过-XX:PretenureSizeThreshold配置）</li>
<li>3、空间分配担保：MinorGC之前，jvm会检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果成立，那么MinorGC可以确保是安全的。如果不成立，则虚拟机会查看HandlePromotionFailure设置值是否允许担保失败。如果允许，那么会继续检查老年代最大可用连续空间是否大于历次晋升到老年代对象的平均大小，如果大于则尝试一次MinorGC，尽管会有风险，如果小于。或者HandlePromotionFailure设置不允许冒险，那这时候也需要改为进行一次Full GC.</li>
<li>因为新生代是使用复制收集算法，但是为了内存利用率，只使用其中一个Survivor空间作为轮换备份，因此当出现大量对象在MinorGC后仍然存活。就需要老年代进行分配担保。把Survivor无法容纳的对象直接进入老年代。前提是老年代还有容纳这些对象的剩余空间，一共有多少对象会存活下来在实际完成内存回收之前是无法明确知道的，所以只好取之前每一次回收晋升到老年代对象容量的平均大小值作为经验值，与老年代的剩余空间比较，决定是否进行FullGc来让老年代腾出空间。如果允许担保失败(HandlePromotionFailure)并且老年代最大可用连续空间大于历次晋升到老年代对象的平均大小，将尝试进行一次MinorGC，如果小于或者不允许担保失败则会进行一次 FullGC，所以一般会将HandlePromotionFailure打开，以防止FullGC频率过高</li>
</ul>
<h3 id="一些JVM工具"><a href="#一些JVM工具" class="headerlink" title="一些JVM工具"></a>一些JVM工具</h3><ul>
<li><p>jps : 虚拟机进程状况工具</p>
<ul>
<li><a href="http://www.importnew.com/?p=18132&amp;preview=true" target="_blank" rel="noopener">详细参考文章</a></li>
<li>-q 只输出LVMID,省略主类名称</li>
<li>-m 输出虚拟机进程启动时传递给主类main()函数的参数</li>
<li>-l 输出主类的全名，如果进程执行的是Jar包，输出jar路径</li>
<li>-v 输出虚拟机进程启动时JVM参数</li>
</ul>
</li>
<li><p>jstat: 虚拟机统计信息监视工具，可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据</p>
<ul>
<li><a href="http://www.importnew.com/18202.html" target="_blank" rel="noopener">详细参考文章</a></li>
<li>-class pid 监视类装载、卸载数量、总空间以及类装载所耗费时间</li>
<li>-gc pid 监视Java堆状况，包括Eden区，两个Survivor区、老年代、永久代容量、已用空间、GC时间合计等信息</li>
<li>-gccapacity pid 可以显示，VM内存中三代（young,old,perm）对象的使用和占用大小</li>
<li>-gcnew pid 年轻代对象的信息</li>
<li>-gcold 年老代对象信息</li>
</ul>
</li>
<li><p>jinfo: java配置信息工具</p>
<ul>
<li>实时地查看和调整虚拟机各项参数，未被显示指定的参数的系统默认值</li>
<li>jinfo -flag CMSInitiatingOccupancyFraction 14444</li>
</ul>
</li>
<li><p>jmap java内存映象工具 用于生成堆转储快照（一般称为heapdump或dump文件）如果不使用jmap命令，还可以使用暴力的手段如：-XX:+HeapDumpOnOutOfMemoryError参数，可以让虚拟机在 OOM异常之后自动生成dump文件。通过-XX:+HeapDumpOnCtrlBreak参数则可以使用[Ctrl]+[Break]键让虚拟机生成dump文件。</p>
<ul>
<li><a href="http://www.importnew.com/18196.html" target="_blank" rel="noopener">详细参考文章</a></li>
<li>jmap 的作用不仅仅是为了获取dump文件，还可以查询finalize执行队列、Java堆和永久代的详细信息，如空间使用率、当前用的是哪种收集器等。</li>
<li><p>-dump 生成java堆转储快照 -dump:[live, ]format=b, file=,其中live子参数说明是否只dump出存活的对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=20190108.dump [pid]</span><br></pre></td></tr></table></figure>
</li>
<li><p>-heap 显示java堆详细信息，如使用那种回收器、参数配置、分代状况等／</p>
</li>
<li>-histo 显示堆中对象的统计信息，包括类，实例数量，合计容量</li>
<li>-F 当虚拟机进程对-dump选项没有响应时，可使用这个选项强制生成dump快照。</li>
<li>例子：jmap -dump:format=b,file=exlipse.bin 3500 (3500 是通过jps命令查询到的LVMID)</li>
</ul>
</li>
<li><p>jhat: 虚拟机堆转储快照分析工具</p>
<ul>
<li>sun JDK提供jhat 与jmap 搭配使用，来分析jmap 生成的堆转储快照。jhat内置了一个微型的Http/Html服务器，生成dump文件的分析结果后，可以在浏览器中查看之后可以用visualVM来分析dump文件</li>
</ul>
</li>
<li><p>jstack: java堆栈跟踪工具，用于生成虚拟机当前时刻的线程快照。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环</p>
<ul>
<li><a href="http://www.importnew.com/18176.html" target="_blank" rel="noopener">详细参考文章</a></li>
</ul>
</li>
</ul>
<h3 id="垃圾收集器参数总结："><a href="#垃圾收集器参数总结：" class="headerlink" title="垃圾收集器参数总结："></a>垃圾收集器参数总结：</h3><ul>
<li>UseSerialGC ：虚拟机运行在Client模式下的默认值，打开此开关后，使用Serial+Serial Old 的收集器组合进行内存回收</li>
<li>UseParNewGC: 打开此开关后使用ParNew+SerialOld的收集器组合进行内存回收</li>
<li>UseConcMarkSweepGC：打开此开关后，使用ParNew+CMS+Serial Old的收集器组合进行内存回收，Serial Old收集器将作为CMS收集器出现Concurrent Mode Failure失败后的后备收集器使用</li>
<li>UseparallelGC 虚拟机运行在Server模式下的默认值，打开此开关后，使用Parallel Scavenge+Serial Old (PS MarkSweep) 的收集器组合进行内存回收<br>UseParallelOldGC: 使用Parallel Scavenge+ Parallel Old的收集器组合进行内存回收</li>
</ul>
<h3 id="GC-相关参数总结"><a href="#GC-相关参数总结" class="headerlink" title="GC 相关参数总结"></a>GC 相关参数总结</h3><ul>
<li>与串行回收器相关的参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseSerialGC:在新生代和老年代使用串行回收器。</span><br><span class="line">-XX:+SurvivorRatio:设置 eden 区大小和 survivor 区大小的比例。</span><br><span class="line">-XX:+PretenureSizeThreshold:设置大对象直接进入老年代的阈值。当对象的大小超过这个值时，将直接在老年代分配。</span><br><span class="line">-XX:MaxTenuringThreshold:设置对象进入老年代的年龄的最大值。每一次 Minor GC 后，对象年龄就加 1。任何大于这个年龄的对象，一定会进入老年代。</span><br></pre></td></tr></table></figure>
<ul>
<li>与并行 GC 相关的参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParNewGC: 在新生代使用并行收集器。</span><br><span class="line">-XX:+UseParallelOldGC: 老年代使用并行回收收集器。</span><br><span class="line">-XX:ParallelGCThreads：设置用于垃圾回收的线程数。通常情况下可以和 CPU 数量相等。但在 CPU 数量比较多的情况下，设置相对较小的数值也是合理的。</span><br><span class="line">-XX:MaxGCPauseMills：设置最大垃圾收集停顿时间。它的值是一个大于 0 的整数。收集器在工作时，会调整 Java 堆大小或者其他一些参数，尽可能地把停顿时间控制在 MaxGCPauseMills 以内。</span><br><span class="line">-XX:GCTimeRatio:设置吞吐量大小，它的值是一个 0-100 之间的整数。假设 GCTimeRatio 的值为 n，那么系统将花费不超过 1/(1+n) 的时间用于垃圾收集。</span><br><span class="line">-XX:+UseAdaptiveSizePolicy:打开自适应 GC 策略。在这种模式下，新生代的大小，eden 和 survivor 的比例、晋升老年代的对象年龄等参数会被自动调整，以达到在堆大小、吞吐量和停顿时间之间的平衡点。</span><br></pre></td></tr></table></figure>
<ul>
<li>与 CMS 回收器相关的参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseConcMarkSweepGC: 新生代使用并行收集器，老年代使用 CMS+串行收集器。</span><br><span class="line">-XX:+ParallelCMSThreads: 设定 CMS 的线程数量。</span><br><span class="line">-XX:+CMSInitiatingOccupancyFraction:设置 CMS 收集器在老年代空间被使用多少后触发，默认为 68%。</span><br><span class="line">-XX:+UseFullGCsBeforeCompaction:设定进行多少次 CMS 垃圾回收后，进行一次内存压缩。</span><br><span class="line">-XX:+CMSClassUnloadingEnabled:允许对类元数据进行回收。</span><br><span class="line">-XX:+CMSParallelRemarkEndable:启用并行重标记。</span><br><span class="line">-XX:CMSInitatingPermOccupancyFraction:当永久区占用率达到这一百分比后，启动 CMS 回收 (前提是-XX:+CMSClassUnloadingEnabled 激活了)。</span><br><span class="line">-XX:UseCMSInitatingOccupancyOnly:表示只在到达阈值的时候，才进行 CMS 回收。</span><br><span class="line">-XX:+CMSIncrementalMode:使用增量模式，比较适合单 CPU。</span><br></pre></td></tr></table></figure>
<ul>
<li>与 G1 回收器相关的参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC：使用 G1 回收器。</span><br><span class="line">-XX:+UnlockExperimentalVMOptions:允许使用实验性参数。</span><br><span class="line">-XX:+MaxGCPauseMills:设置最大垃圾收集停顿时间。</span><br><span class="line">-XX:+GCPauseIntervalMills:设置停顿间隔时间。</span><br></pre></td></tr></table></figure>
<ul>
<li>其他参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+DisableExplicitGC: 禁用显示 GC。</span><br></pre></td></tr></table></figure>
<h3 id="JVM调优实战"><a href="#JVM调优实战" class="headerlink" title="JVM调优实战"></a>JVM调优实战</h3><p>除了Java堆和永久代之外还有以下区域还会占用较多的内存，这些内存总和受到操作系统进程最大内存的限制</p>
<ul>
<li>DirectMemory：可通过 -XX:MaxDirectMemorySize调整大小，内存不足时抛出OutOfMemoryError 或者 OutOfMemoryError: Direct buffer memory.如果把系统大部分的内存都分配给了java堆，并且很长时间没有发生GC操作。那么DirectMemory可能会溢出。因为DirectMemory只是等待老年代满了之后FullGC，然后顺便帮它清理掉内存的废弃对象。否则就只能一直等到抛出内存溢出异常。</li>
<li>线程堆栈： 可通过-Xss调整大小，内存不足时抛出StackOverflowError</li>
<li>Socket 缓存区：每个Socket连接都Receive和Send两个缓存区，分别占大约37KB和25KB内存，连续多的话这块内存也很可观。</li>
<li>JNI 代码：如果代码中使用JNI调用本地库，那本地库使用的内存也不在堆中。</li>
<li>虚拟机和GC：虚拟机、GC的代码执行也要消耗一定的内存</li>
</ul>
<ul>
<li>解读GC 日志</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) 2017-10-15T16:02:33.567+0800: 790.871: [ParNew</span><br><span class="line">Desired survivor size 17432576 bytes, new threshold 6 (max 6)</span><br><span class="line">- age 1: 7619992 bytes, 7619992 total</span><br><span class="line">- age 2: 1081760 bytes, 8701752 total</span><br></pre></td></tr></table></figure>
<p>可以明显看出上述 GC 日志包含两次 Minor GC。 注意到第二次 Minor GC 的情况， 日志打出 “Desired survivor size 53673984 bytes”， 但是却存活了 “- age 1: 107256200 bytes, 107256200 total” 这么多。 可以看出明显的新生代的 Survivor 空间不足。正因为 Survivor 空间不足， 那么从 Eden 存活下来的和原来在 Survivor 空间中不够老的对象占满 Survivor 后， 就会提升到老年代， 可以看到这一轮 Minor GC 后老年代由原来的 0K 占用变成了 105782K 占用， 这属于一个典型的 JVM 内存问题， 称为 “premature promotion”(过早提升)。”premature promotion” 在短期看来不会有问题， 但是经常性的”premature promotion”， 最总会导致大量短期对象被提升到老年代， 最终导致老年代空间不足， 引发另一个 JVM 内存问题 “promotion failure”（提升失败： 即老年代空间不足以容乃 Minor GC 中提升上来的对象）。 “promotion failure” 发生就会让 JVM 进行一次 CMS 垃圾收集进而腾出空间接受新生代提升上来的对象， CMS 垃圾收集时间比 Minor GC 长， 导致吞吐量下降、 时延上升， 将对用户体验造成影响。</p>
<h3 id="Java什么情况下会报OutOfMemoryError"><a href="#Java什么情况下会报OutOfMemoryError" class="headerlink" title="Java什么情况下会报OutOfMemoryError"></a>Java什么情况下会报OutOfMemoryError</h3><ul>
<li>如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StatckOverflowError异常；若果虚拟机栈可以动态扩展(当前大部分的Java虚拟机都可动态扩展，只不过Java虚拟机规范中也允许固定长度的虚拟机栈)，当扩展时无法申请到足够的内存时会抛出OutOfMemoryError异常。</li>
<li>根据Java虚拟机规范的规定，Java堆可以处于物理上不连续的内存空间中，只要逻辑上是连续的即可，就像我们的磁盘空间一样，在实现时，既可以实现成固定大小的，也可以是可扩展的，不过当前主流的虚拟机都是按照可扩展来实现的(通过-Xmx和-Xms控制)。如果在堆中没有内存完成实例分配，并且堆也无法再扩展时，将会抛出OutOfMemoryError异常。</li>
<li>根据Java虚拟机规范的规定，当方法区无法满足内存分配需求时，将抛出OutOfMemoryError异常。</li>
<li>运行时常量池是方法区的一部分，自然会受到方法区内存的限制，当常量池无法在申请到内存时会抛出OutOfMemoryError异常。</li>
<li>直接内存(Direct Memory)并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用，而且也可能导致OutOfMemoryError异常的出现。在JDK1.4中新加入了NIO(New Input/Output)类，引入了一种基于通道(Channel)与缓冲区(Buffer)的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作，这样能在一些场景中显著提高性能，因为避免了在Java堆和Native中来回复制数据。显然，本机直接内存的分配不会受到Java堆大小的限制，但是，既然是内存，则肯定还是会受到本机总内存(包括RAM及SWAP区或分页文件)的大小及处理器寻址空间的限制。</li>
</ul>
<h3 id="虚拟机类加载机制"><a href="#虚拟机类加载机制" class="headerlink" title="虚拟机类加载机制"></a>虚拟机类加载机制</h3><ul>
<li>类加载的生命周期：加载—验证—准备—解析—初始化—使用—卸载</li>
<li><p>类初始化阶段：<br>是类加载过程的最后一步，到了初始化阶段，才真正开始执行类中定义的Java程序代码（或者说字节码）<br>在准备阶段，变量已经赋值锅系统要求的初始值，，而在初始化阶段，则根据程序员通过程序制定的主观计划去初始化类变量和其他资源，从另一个方面表达：<br>初始化阶段是执行类构造器()方法的过程。<br>方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块(static{}块)中的语句合并产生的，编译器收集的顺序是由语句在原文件中出现的顺序决定的。</p>
</li>
<li><p>静态语句块中只能访问到定义在静态语句块之前的变量，定义在它之后的变量，在前面的静态语句块可以赋值，但是不能访问。如：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class test&#123;</span><br><span class="line">static&#123;</span><br><span class="line">i=0; //给变量赋值可以正常编译通过</span><br><span class="line">System.out.print(i); //这句编译器会提示“非法向前引用”</span><br><span class="line">&#125;</span><br><span class="line">static int i=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  () 方法与类的构造函数不同，它不需要显示的调用父类构造器，虚拟机会保证在子类的clinit方法执行之前，父类的cinit方法已经执行完毕。因此在虚拟机中第一个被执行的cinit方法的类肯定是java.lang.object。由于父类的clinit方法先执行，也就意味着父类中定义的静态语句块要优先于子类变量赋值操作。比如如下B的值将会是2而不是1</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static class Parent&#123;</span><br><span class="line">public static int A =1;</span><br><span class="line">	static &#123;</span><br><span class="line">	A =2</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static class Sub extends Parent&#123;</span><br><span class="line">public static int B=A</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args)&#123;</span><br><span class="line">system.out.println(Sub.B);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>- 1）clinit 方法不是必须的，如果一个类中没有静态语句块，也没有对变量的赋值操作，也就没有必要为这个类生成clint方法。
- 2）接口中不能使用静态语句块，但仍然有变量初始化赋值操作，因此接口和类一样都会生成clinit方法。但接口与类不同的是，执行接口的clinit方法不需要先执行父接口的clinit方法。只有当父接口中定义的变量使用时，父接口才会初始化。另外，接口实现类在初始化时也一样不会执行接口的clinit方法
- 3）虚拟机保证一个类的clinit方法在多线程环境中被正确地加锁、同步，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的clinit方法，其他线程都需要阻塞等待，直到活动线程执行clinit方法完毕。同一个类加载器下，一个类型只会初始化一次
</code></pre><ul>
<li>类加载器<ul>
<li>1）用于实现类的加载动作.比较两个类是否相等，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则即使来源于同一个Class文件，被同一个虚拟机加载，只要类加载器不同，那么这两个类就必定不相等。相等指的是 equals() isAssignableFrom()方法，isInstance()方法返回的结果。也包括使用instanceof关键字做对象所属关系判定等情况。</li>
<li>2）双亲委派模型<br>从Java虚拟机的角度，只存在两种不同的类加载器：一种是启动类加载器(Bootstrap ClassLoader)，这个类加载器由C++实现，另一种就是所有其他的类加载器，由Java实现并且都继承自抽象类java.lang.ClassLoader</li>
<li>3）从开发人员的角度，类加载器还可以分更细：<ul>
<li>启动类加载器(Bootstrap ClassLoader)：负责加载Java_HOME\lib目录中的，或者被-Xbooclasspath参数所指定的路径中的，并且是虚拟机识别的类库加载到虚拟机内存中。无法被java程序直接饮用。</li>
<li>扩展类加载器（Extension ClassLoader） 负责加载JAVA_HOME\lib\ext目录中，或者被java.ext.dirs系统变量所指定的路径中的所有类库，开发者可以直接使用扩展类加载器</li>
<li>应用程序加载器（Application ClassLoader） 这个类加载器是ClassLoader中的getSystemClassLoader()方法的返回值，所以也被称为系统类加载器。负责加载用户类路径（ClassPath）上所指定的类库，如果应用程序没有自定义锅自己的类加载器，一般情况下这个就是程序中默认的类加载器</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="JVM逃逸分析"><a href="#JVM逃逸分析" class="headerlink" title="JVM逃逸分析"></a><a href="http://www.importnew.com/23150.html" target="_blank" rel="noopener">JVM逃逸分析</a></h3><ul>
<li>逃逸分析的基本行为就是分析对象动态作用域：当一个对象在方法中被定义后，它可能被外部方法所引用，例如作为调用参数传递到其他地方中，称为方法逃逸</li>
<li>如果能证明一个对象不会逃逸到方法或线程外，则可能为这个变量进行一些高效的优化</li>
</ul>
<h4 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h4><ul>
<li>栈上分配<ul>
<li>我们都知道Java中的对象都是在堆上分配的，而垃圾回收机制会回收堆中不再使用的对象，但是筛选可回收对象，回收对象还有整理内存都需要消耗时间。如果能够通过逃逸分析确定某些对象不会逃出方法之外，那就可以让这个对象在栈上分配内存，这样该对象所占用的内存空间就可以随栈帧出栈而销毁，就减轻了垃圾回收的压力。</li>
<li>在一般应用中，如果不会逃逸的局部对象所占的比例很大，如果能使用栈上分配，那大量的对象就会随着方法的结束而自动销毁了。</li>
</ul>
</li>
<li>同步消除：参考<a href="https://my.oschina.net/hosee/blog/615865" target="_blank" rel="noopener">高并发Java 九锁的优化和注意事项</a></li>
<li>标量替换<ul>
<li>Java虚拟机中的原始数据类型（int，long等数值类型以及reference类型等）都不能再进一步分解，它们就可以称为标量。相对的，如果一个数据可以继续分解，那它称为聚合量，Java中最典型的聚合量是对象。如果逃逸分析证明一个对象不会被外部访问，并且这个对象是可分解的，那程序真正执行的时候将可能不创建这个对象，而改为直接创建它的若干个被这个方法使用到的成员变量来代替。拆散后的变量便可以被单独分析与优化，可以各自分别在栈帧或寄存器上分配空间，原本的对象就无需整体分配空间了</li>
</ul>
</li>
</ul>
<h3 id="JIT-与Java10"><a href="#JIT-与Java10" class="headerlink" title="JIT 与Java10"></a>JIT 与Java10</h3><ul>
<li>Introduction:<ul>
<li>对于大部分应用开发者来说，Java编译器指的是JDK自带的javac指令。这一指令可将Java源程序编译成.class文件，其中包含的代码格式我们称之为Java bytecode（Java字节码）。这种代码格式无法直接运行，但可以被不同平台JVM中的interpreter解释执行。<em>由于interpreter效率低下，JVM中的JIT compiler（即时编译器）会在运行时有选择性地将运行次数较多的方法编译成二进制代码，直接运行在底层硬件上。</em>Oracle的HotSpot VM便附带两个用C++实现的JIT compiler：C1及C2。</li>
<li>与interpreter，GC等JVM的其他子系统相比，JIT compiler并不依赖于诸如直接内存访问的底层语言特性。它可以看成一个输入Java bytecode输出二进制码的黑盒，其实现方式取决于开发者对开发效率，可维护性等的要求。Graal是一个以Java为主要编程语言，面向Java bytecode的编译器。与用C++实现的C1及C2相比，它的模块化更加明显，也更加容易维护。Graal既可以作为动态编译器，在运行时编译热点方法；亦可以作为静态编译器，实现AOT编译。在Java 10中，Graal作为试验性JIT compiler一同发布（JEP 317）。这篇文章将介绍Graal在动态编译上的应用。有关静态编译，可查阅JEP 295或Substrate VM。</li>
</ul>
</li>
<li>Tiered Compilation<ul>
<li>HotSpot中的tiered compilation<ul>
<li>JIT compiler — C1及C2（或称为Client及Server）<ul>
<li>前者没有应用激进的优化技术，因为这些优化往往伴随着耗时较长的代码分析。因此，C1的编译速度较快，而C2所编译的方法运行速度较快。在Java 7前，用户需根据自己的应用场景选择合适的JIT compiler。举例来说，针对偏好高启动性能的GUI用户端程序则使用C1，针对偏好高峰值性能的服务器端程序则使用C2。</li>
<li>Java 7引入了tiered compilation的概念，综合了C1的高启动性能及C2的高峰值性能。这两个JIT compiler以及interpreter将HotSpot的执行方式划分为五个级别：<ul>
<li>level 0：interpreter解释执行</li>
<li>level 1：C1编译，无profiling</li>
<li>level 2：C1编译，仅方法及循环back-edge执行次数的profiling</li>
<li>level 3：C1编译，除level 2中的profiling外还包括branch（针对分支跳转字节码）及receiver type（针对成员方法调用或类检测，如checkcast，instnaceof，aastore字节码）的profiling</li>
<li>level 4：C2编译。其中，1级和4级为接受状态 — 除非已编译的方法被invalidated（通常在deoptimization中触发），否则HotSpot不会再发出该方法的编译请求。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="JVM优秀博客"><a href="#JVM优秀博客" class="headerlink" title="JVM优秀博客"></a>JVM优秀博客</h3><ul>
<li><a href="http://www.importnew.com/30461.html" target="_blank" rel="noopener">Java字节码结构剖析一：常量池</a></li>
<li><a href="http://www.importnew.com/30505.html" target="_blank" rel="noopener">Java字节码结构剖析二：字段表
</a></li>
<li><a href="http://www.importnew.com/30521.html" target="_blank" rel="noopener">Java字节码结构剖析三：方法表
</a></li>
<li><a href="http://www.importnew.com/26595.html" target="_blank" rel="noopener">从字节码和 JVM 的角度解析 Java 核心类 String 的不可变特性</a></li>
<li><a href="https://my.oschina.net/hosee?tab=popular" target="_blank" rel="noopener">高并发java博客系列</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-10-31T03:15:14.000Z">2017-10-31</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    15 分钟 读完 (大约 2188 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/10/31/kylin-query原理剖析/">kylin query原理剖析</a>
            
        </h1>
        <div class="content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近我们组负责数据建模的同学抱怨kylin的relization选择策略：同一个project下一条查询语句本来期望命中某一个cube的，结果系统却选择了其他cube。之前也有大概翻阅过kylin这块的实现源码，知道如果同一个project下如果有多个满足条件的的实现，会按照成本排序并选择成本最低的那个实现。对于成本这块的度量标准，没有做过多研究，于是带着问题，对这块源码进行了一次梳理。</p>
<h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2><p>为使博文简洁相关实现只贴部分核心代码，以下所指的Realization对应于构建好的Cube。</p>
<h4 id="查询入口"><a href="#查询入口" class="headerlink" title="查询入口"></a>查询入口</h4><ul>
<li>QueryService.doQueryWithCache()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> //kylin.query.cache-enabled是否开启，如果开启将会从cache里面去读结果</span><br><span class="line"> if (queryCacheEnabled) &#123;</span><br><span class="line">	sqlResponse = searchQueryInCache(sqlRequest);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> try &#123;</span><br><span class="line">if (null == sqlResponse) &#123;</span><br><span class="line">	if (isSelect) &#123;</span><br><span class="line">		//查询入口</span><br><span class="line">		sqlResponse = query(sqlRequest);</span><br><span class="line">	&#125; else if (kylinConfig.isPushDownEnabled() &amp;&amp; kylinConfig.isPushDownUpdateEnabled()) &#123;</span><br><span class="line">		//如果开启了pushDown的话允许非查询的sql，如update</span><br><span class="line">		sqlResponse = update(sqlRequest);</span><br><span class="line">	&#125; else &#123;	</span><br><span class="line">		logger.debug(&quot;Directly return exception as the sql is unsupported, and query pushdown is disabled&quot;);</span><br><span class="line">                       throw new BadRequestException(msg.getNOT_SUPPORTED_SQL());</span><br><span class="line">			&#125;</span><br><span class="line"> ...</span><br><span class="line"> catch()&#123;</span><br><span class="line"> 	...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们忽略从缓存中查找（searchQueryInCache），以及非select查询的情况，单单从一次正常的查询进行分析，进入query方法。</p>
<ul>
<li>QueryService.query()</li>
</ul>
<p>query方法相对来说比较简单，记录了query开始和结束的信息，相当于做了一个切面的工作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public SQLResponse query(SQLRequest sqlRequest) throws Exception &#123;</span><br><span class="line">    SQLResponse ret = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        final String user = SecurityContextHolder.getContext().getAuthentication().getName();</span><br><span class="line">        badQueryDetector.queryStart(Thread.currentThread(), sqlRequest, user);</span><br><span class="line"></span><br><span class="line">        ret = queryWithSqlMassage(sqlRequest);</span><br><span class="line">        return ret;</span><br><span class="line"></span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        String badReason = (ret != null &amp;&amp; ret.isPushDown()) ? BadQueryEntry.ADJ_PUSHDOWN : null;</span><br><span class="line">        badQueryDetector.queryEnd(Thread.currentThread(), badReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中badQueryDetector是一个单起的线程，用来统计和监测bad query的。当有bad query时notify相关的观察者，做一些操作，如打印日志，记录bad query等。kylin 中很多事件的通知都是通过生产者消费者模式订阅发布的。继续进入queryWithSqlMessage()</p>
<ul>
<li>QueryService.queryWithSqlMessage()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Connection conn = null;</span><br><span class="line">try &#123;</span><br><span class="line">	 conn = QueryConnection.getConnection(sqlRequest.getProject());</span><br><span class="line">	 ...</span><br><span class="line">	 return execute(correctedSql, sqlRequest, conn);</span><br><span class="line">	 ...</span><br><span class="line">   &#125; finally &#123;</span><br><span class="line">		DBUtils.closeQuietly(conn);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法里首先获取了数据库连接，kylin的查询的中间层是基于Calcite的，接下来会看一下QueryConnection背后的逻辑。不过话说回来kylin这种整个大块的try catch异常捕获的机制某种意义上来说是种不负责任的表现。</p>
<ul>
<li>QueryConnection.getConnection():</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static Connection getConnection(String project) throws SQLException &#123;</span><br><span class="line">    if (!isRegister) &#123;</span><br><span class="line">        DriverManager.registerDriver(new Driver());</span><br><span class="line">        isRegister = true;</span><br><span class="line">    &#125;</span><br><span class="line">    File olapTmp = OLAPSchemaFactory.createTempOLAPJson(project, KylinConfig.getInstanceFromEnv());</span><br><span class="line">    Properties info = new Properties();</span><br><span class="line">    info.put(&quot;model&quot;, olapTmp.getAbsolutePath());</span><br><span class="line">    return DriverManager.getConnection(&quot;jdbc:calcite:&quot;, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法比较简单，主要是通过OLAPSchemaFactory.createTempOLAPJson()生成了连接的元数据文件，用来创建连接</p>
<ul>
<li>OLAPSchemaFactory</li>
</ul>
<p>OLAPSchemaFactory 实现了calcite的 SchemaFactory接口，实现了create方法，用来创建连接时生成Schema</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Schema create(SchemaPlus parentSchema, String schemaName, Map&lt;String, Object&gt; operand) &#123;</span><br><span class="line">    String project = (String) operand.get(SCHEMA_PROJECT);</span><br><span class="line">    Schema newSchema = new OLAPSchema(project, schemaName, false);</span><br><span class="line">    return newSchema;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在OLAPSchema的init方法中调用了KylinConfigBase.getStorageUrl方法，此方法返回了我们在配置文件中配置的kylin数据的存储信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public StorageURL getStorageUrl() &#123;</span><br><span class="line">        String url = getOptional(&quot;kylin.storage.url&quot;, &quot;default@hbase&quot;);</span><br><span class="line">        </span><br><span class="line">        // for backward compatibility</span><br><span class="line">        // 对2.0早期版本的配置做了兼容</span><br><span class="line">        if (&quot;hbase&quot;.equals(url))</span><br><span class="line">            url = &quot;default@hbase&quot;;</span><br><span class="line"></span><br><span class="line">        return StorageURL.valueOf(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里也可以看出kylin默认的存储系统是HBase</p>
<ul>
<li>QueryService.execute()</li>
</ul>
<p>从之前的QueryService.queryWithSqlMessage()方法继续往下深入到 execute()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ResultSet resultSet = null;</span><br><span class="line">if (isPrepareStatementWithParams(sqlRequest)) &#123;</span><br><span class="line">	stat = conn.prepareStatement(correctedSql); // to be closed in the finally</span><br><span class="line">	PreparedStatement prepared = (PreparedStatement) stat;</span><br><span class="line">	processStatementAttr(prepared, sqlRequest);</span><br><span class="line">	for (int i = 0; i &lt; ((PrepareSqlRequest) sqlRequest).getParams().length; i++) &#123;</span><br><span class="line">			setParam(prepared, i + 1, ((PrepareSqlRequest) sqlRequest).getParams()[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	resultSet = prepared.executeQuery();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	stat = conn.createStatement();</span><br><span class="line">	processStatementAttr(stat, sqlRequest);</span><br><span class="line">	resultSet = stat.executeQuery(correctedSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OLAPTable</li>
</ul>
<p>最后查出的结果是在resultSet里，追踪到这一步发现再往下追踪都是Calcite底层的逻辑了，kylin肯定是对Calcite 做了一定的扩展，并且将结果按照kylin预定义的规则做了各种聚合操作。Calcite文档中表示，可以实现三种类型的Table:</p>
<ul>
<li>a simple implementation of Table, using the ScannableTable interface, that enumerates all rows directly;</li>
<li>a more advanced implementation that implements FilterableTable, and can filter out rows according to simple predicates;</li>
<li>advanced implementation of Table, using TranslatableTable, that translates to relational operators using planner rules.</li>
</ul>
<p>发现在core-query模块中OLAPTable 实现了TranslatableTable。而OLAPTable 中实现的asQueryable方法有三种Enumerator的实现，这里默认选的是OLAP的实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public &lt;T&gt; Queryable&lt;T&gt; asQueryable(QueryProvider queryProvider, SchemaPlus schema, String tableName) &#123;</span><br><span class="line">       return new AbstractTableQueryable&lt;T&gt;(queryProvider, schema, this, tableName) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            public Enumerator&lt;T&gt; enumerator() &#123;</span><br><span class="line">                final OLAPQuery query = new OLAPQuery(EnumeratorTypeEnum.OLAP, 0);</span><br><span class="line">                return (Enumerator&lt;T&gt;) query.enumerator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">OLAPQuery.enumerator</span><br><span class="line">public Enumerator&lt;Object[]&gt; enumerator() &#123;</span><br><span class="line">        OLAPContext olapContext = OLAPContext.getThreadLocalContextById(contextId);</span><br><span class="line">        switch (type) &#123;</span><br><span class="line">        case OLAP:</span><br><span class="line">            return BackdoorToggles.getPrepareOnly() ? new EmptyEnumerator() : new OLAPEnumerator(olapContext, optiqContext);</span><br><span class="line">        case LOOKUP_TABLE:</span><br><span class="line">            return BackdoorToggles.getPrepareOnly() ? new EmptyEnumerator() : new LookupTableEnumerator(olapContext);</span><br><span class="line">        case HIVE:</span><br><span class="line">            return BackdoorToggles.getPrepareOnly() ? new EmptyEnumerator() : new HiveEnumerator(olapContext);</span><br><span class="line">        default:</span><br><span class="line">            throw new IllegalArgumentException(&quot;Wrong type &quot; + type + &quot;!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OLAPEnumerator.queryStorage()</li>
</ul>
<p>由OLAPTable.asQueryable进入，到了OLAPEnumerator.queryStorage()，终于能看到真实的查库操作了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private ITupleIterator queryStorage() &#123;</span><br><span class="line">    logger.debug(&quot;query storage...&quot;);</span><br><span class="line"></span><br><span class="line">    // bind dynamic variables</span><br><span class="line">    bindVariable(olapContext.filter);</span><br><span class="line"></span><br><span class="line">    olapContext.resetSQLDigest();</span><br><span class="line">    SQLDigest sqlDigest = olapContext.getSQLDigest();</span><br><span class="line"></span><br><span class="line">    // query storage engine</span><br><span class="line">    IStorageQuery storageEngine = StorageFactory.createQuery(olapContext.realization);</span><br><span class="line">    ITupleIterator iterator = storageEngine.search(olapContext.storageContext, sqlDigest, olapContext.returnTupleInfo);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;return TupleIterator...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return iterator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里StorageEngine 由StorageFactory创建，且有三种不同的实现，默认还是HBase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   private static ThreadLocal&lt;ImplementationSwitch&lt;IStorage&gt;&gt; storages = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   public static IStorage storage(IStorageAware aware) &#123;</span><br><span class="line">       ImplementationSwitch&lt;IStorage&gt; current = storages.get();</span><br><span class="line">       if (storages.get() == null) &#123;</span><br><span class="line">           current = new ImplementationSwitch&lt;&gt;(KylinConfig.getInstanceFromEnv().getStorageEngines(), IStorage.class);</span><br><span class="line">           storages.set(current);</span><br><span class="line">       &#125;</span><br><span class="line">       return current.get(aware.getStorageType());</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">  //KylinConfig.getInstanceFromEnv().getStorageEngines()</span><br><span class="line">public Map&lt;Integer, String&gt; getStorageEngines() &#123;</span><br><span class="line">       Map&lt;Integer, String&gt; r = Maps.newLinkedHashMap();</span><br><span class="line">       // ref constants in IStorageAware</span><br><span class="line">       r.put(0, &quot;org.apache.kylin.storage.hbase.HBaseStorage&quot;);</span><br><span class="line">       r.put(1, &quot;org.apache.kylin.storage.hybrid.HybridStorage&quot;);</span><br><span class="line">       r.put(2, &quot;org.apache.kylin.storage.hbase.HBaseStorage&quot;);</span><br><span class="line">       r.putAll(convertKeyToInteger(getPropertiesByPrefix(&quot;kylin.storage.provider.&quot;)));</span><br><span class="line">       return r;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OLAPTableScan.register()</li>
</ul>
<p>由于OLAPTable实现了TranslatableTable，它会通过一系列的relation operators将结果聚合,relation operators的注册逻辑在OLAPTableScan中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void register(RelOptPlanner planner) &#123;</span><br><span class="line">       // force clear the query context before traversal relational operators</span><br><span class="line">       OLAPContext.clearThreadLocalContexts();</span><br><span class="line"></span><br><span class="line">       // register OLAP rules</span><br><span class="line">       planner.addRule(OLAPToEnumerableConverterRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPFilterRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPProjectRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPAggregateRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPJoinRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPLimitRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPSortRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPUnionRule.INSTANCE);</span><br><span class="line">       planner.addRule(OLAPWindowRule.INSTANCE);</span><br><span class="line">       ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里着重看OLAPToEnumerableConverterRule 里返回的 OLAPToEnumerableConverter的实现，它是解释我在前言里提到的问题的关键。</p>
<ul>
<li>OLAPToEnumerableConverter.implement()</li>
</ul>
<p>这里面有对所有满足query条件的realization选择的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public Result implement(EnumerableRelImplementor enumImplementor, Prefer pref) &#123;</span><br><span class="line"> 	  </span><br><span class="line"> 	 ...</span><br><span class="line">     // identify model &amp; realization</span><br><span class="line">     List&lt;OLAPContext&gt; contexts = listContextsHavingScan();</span><br><span class="line"></span><br><span class="line">     // intercept query</span><br><span class="line">     List&lt;QueryInterceptor&gt; intercepts = QueryInterceptorUtil.getQueryInterceptors();</span><br><span class="line">     for (QueryInterceptor intercept : intercepts) &#123;</span><br><span class="line">         intercept.intercept(contexts);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">//RealizationChooser 中有对Realization选择的具体实现</span><br><span class="line">     RealizationChooser.selectRealization(contexts);</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line">return impl.visitChild(this, 0, inputAsEnum, pref);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>RealizationChooser.attemptSelectRealization()</li>
</ul>
<p>attemptSelectRealization方法里面主要干了两件事： 1）拉取属于该project与factTableName下的所有Realization，经过一系列的条件过滤掉不符合query的Realization，并将符合条件的Realization按照RealizationCost排序。2）对第一步收集的Realization map，调用QueryRouter.selectRealization()，一旦QueryRouter.selectRealization()有返回值立即中断循环返回最终选择的Realization</p>
<ul>
<li>RealizationChooser.makeOrderedModelMap() 部分的实现逻辑如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">  //按条件过滤realization</span><br><span class="line">   for (IRealization real : realizations) &#123;</span><br><span class="line">       //过滤disabled cube</span><br><span class="line">       if (real.isReady() == false) &#123;</span><br><span class="line">           context.realizationCheck.addIncapableCube(real,</span><br><span class="line">                   RealizationCheck.IncapableReason.create(RealizationCheck.IncapableType.CUBE_NOT_READY));</span><br><span class="line">           continue;</span><br><span class="line">       &#125;</span><br><span class="line">       //过滤不包含querycontext里面全部的columns</span><br><span class="line">       if (containsAll(real.getAllColumnDescs(), first.allColumns) == false) &#123;</span><br><span class="line">           context.realizationCheck.addIncapableCube(real, RealizationCheck.IncapableReason</span><br><span class="line">                   .notContainAllColumn(notContain(real.getAllColumnDescs(), first.allColumns)));</span><br><span class="line">           continue;</span><br><span class="line">       &#125;</span><br><span class="line">       ／／过滤存在黑名单里面的cube</span><br><span class="line">       if (RemoveBlackoutRealizationsRule.accept(real) == false) &#123;</span><br><span class="line">           context.realizationCheck.addIncapableCube(real, RealizationCheck.IncapableReason</span><br><span class="line">                   .create(RealizationCheck.IncapableType.CUBE_BLACK_OUT_REALIZATION));</span><br><span class="line">           continue;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">//过滤完，按RealizationCost排序</span><br><span class="line">       RealizationCost cost = new RealizationCost(real);</span><br><span class="line">       DataModelDesc m = real.getModel();</span><br><span class="line">       Set&lt;IRealization&gt; set = models.get(m);</span><br><span class="line">       if (set == null) &#123;</span><br><span class="line">           set = Sets.newHashSet();</span><br><span class="line">           set.add(real);</span><br><span class="line">           models.put(m, set);</span><br><span class="line">           costs.put(m, cost);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           set.add(real);</span><br><span class="line">           RealizationCost curCost = costs.get(m);</span><br><span class="line">           if (cost.compareTo(curCost) &lt; 0)</span><br><span class="line">               costs.put(m, cost);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>重点就在RealizationCost的实现里了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public RealizationCost(IRealization real) &#123;</span><br><span class="line">          // ref Candidate.PRIORITIES</span><br><span class="line">          this.priority = Candidate.PRIORITIES.get(real.getType());</span><br><span class="line"></span><br><span class="line">          // ref CubeInstance.getCost()</span><br><span class="line">          int c = real.getAllDimensions().size() * CubeInstance.COST_WEIGHT_DIMENSION</span><br><span class="line">                  + real.getMeasures().size() * CubeInstance.COST_WEIGHT_MEASURE;</span><br><span class="line">          for (JoinTableDesc join : real.getModel().getJoinTables()) &#123;</span><br><span class="line">              if (join.getJoin().isInnerJoin())</span><br><span class="line">                  c += CubeInstance.COST_WEIGHT_INNER_JOIN;</span><br><span class="line">          &#125;</span><br><span class="line">          this.cost = c;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>到此，对于kylin的Realization的成本计算规则清楚了。就是对dimension，measure,jointable三个维度的数量进行加权求和，得到的就是每个Realization对应的成本。相对的，每个维度对应的权重是有所斟酌的，dimension对应的是10，measure为1（考虑到是预计算的结果），jointable为100。从这也能看出建模时应该考虑的优化方向：避免过多的dimension，以及jointable的操作，结果尽量从预计算中出。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次经过对kylin query源码的分析，基本上对kylin的核心代码都过了一遍，学习了不少优秀的代码解耦方式，也对底层原理加深了理解。关于RealizationCost的实现，目前kylin实现比较简单，在遍历所有满足条件的实现时找到Realization便返回处理的有些过于仓促。对于其是map的结构或许kylin在之后的扩展方面也是有所考虑。目前我们还不打算扩展Realizaiton的选择策略，了解了源码就可以在建模层面将查询结果不如意的情况给规避了。</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-10-13T06:35:12.000Z">2017-10-13</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1426 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/10/13/superset-customization/">superset customization</a>
            
        </h1>
        <div class="content">
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><ul>
<li><p>由于数据组目前重度依赖kylin，然而kylin并没有官方开源的数据可视化工具。所幸kylin提供了丰富的查询API供我们直接传入SQL进行查询，与此同时发现superset有非官方对接kylin的开源插件，虽然两年没有维护了，对代码进行了部分重构也就成功将superset和kylin对接起来了。</p>
</li>
<li><p>通常一个开源框架在使用过程中，总是会有各种各样的针对具体场景的定制化需求，superset自然不例外。于是下面简单记录一下superset定制化的过程中干的一些事情，算是做一个小的总结。</p>
</li>
</ul>
<h3 id="python2升级python3"><a href="#python2升级python3" class="headerlink" title="python2升级python3"></a>python2升级python3</h3><p>虽然python2.7是superset官方推荐的版本，但是由于python2.7默认的Encoding的问题导致使用过程中一旦出现中文就出错。为了避免这种情况，我选择将python2.7升级到python3.5。当然升级还算顺利，碰到的最大的坑就是python2中的MysqlDB模块在python3中已经不维护了，于是修改superset源码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#init.py</span><br><span class="line">#pip install pymysql</span><br><span class="line"></span><br><span class="line">import pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<h3 id="superset-ldap配置"><a href="#superset-ldap配置" class="headerlink" title="superset ldap配置"></a>superset ldap配置</h3><ul>
<li><p>基本上各大开源组件都支持ldap的配置，superset也不例外。ldap的好处就是给企业用户提供统一的账户授权，方便权限管理。</p>
</li>
<li><p>由于google上基本上查不到相关的资料或者都是配置出错了没法解决的提问，这一块踩了不少的坑。然后发现superset其实是直接用的flask-appbuilder里提供的security组件支持ldap的，通过熟悉ldap的原理以及查看flask-appbuilder的官方文档和security组件的源代码最终解决了ldap的配置问题。</p>
</li>
<li><p>先在config.py中引入flask-appbuilder的相关依赖</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#引入引用：</span><br><span class="line">from flask_appbuilder.security.manager import AUTH_OID,</span><br><span class="line">AUTH_REMOTE_USER,</span><br><span class="line">AUTH_DB, AUTH_LDAP,</span><br><span class="line">AUTH_OAUTH,</span><br><span class="line">AUTH_OAUTH</span><br></pre></td></tr></table></figure>
</li>
<li><p>再在config.py AUTH一块的区域中加入如下配置</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//最终配置（这里用到二次验证，即bind给定账户，然后根据权限去搜索输入的用户，拉	取用户的dn，最后用得到的密码和拉取到的dn去bind_user即可）</span><br><span class="line">#2表示使用ldap</span><br><span class="line">AUTH_TYPE = 2 </span><br><span class="line">#自己公司的ldap服务器</span><br><span class="line">AUTH_LDAP_SERVER = &quot;ldap://ldap.example.com&quot; </span><br><span class="line">#ldap有两种认证方式，这里用到二次验证，需要配置一个admin账号</span><br><span class="line">AUTH_LDAP_BIND_USER = &quot;cn=admin,dc=ldap,dc=mobvoi,dc=com&quot;</span><br><span class="line">#admin账号的密码</span><br><span class="line">AUTH_LDAP_BIND_PASSWORD = &quot;xxxx&quot;</span><br><span class="line">AUTH_LDAP_USE_TLS = False</span><br><span class="line">#在哪个节点查找用户</span><br><span class="line">AUTH_LDAP_SEARCH = &quot;ou=users,dc=ldap,dc=mobvoi,dc=com&quot;</span><br><span class="line">#查找用户的字段</span><br><span class="line">AUTH_LDAP_UID_FIELD = &quot;uid&quot;</span><br><span class="line">#是否允许superset数据库中没有记录的ldap用户自动注册</span><br><span class="line">AUTH_USER_REGISTRATION = True</span><br><span class="line">#注册新用户时默认分配的权限</span><br><span class="line">AUTH_USER_REGISTRATION_ROLE = &quot;Dashboard Readonly&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="superset-docker化"><a href="#superset-docker化" class="headerlink" title="superset docker化"></a>superset docker化</h3><p>为了减轻运维服务器升级时服务的迁移成本，决定将统一修改的源码托管起来，每一次修改重新发布docker，这样能大大降低运维成本。</p>
<ul>
<li><p>拉取ubuntu镜像，挂载本地磁盘，并进入后台运行模式</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it -v /home/:/home/ leemiracle/unbuntu /bin/bash</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>在ubuntu中安装python3.5</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.5.4/Python-3.5.4rc1.tgz</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>拖下superset、pylin源代码，安装pyklin 与ldap</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clonet git@github.com:lichaojacobs/superset.git</span><br><span class="line">git clone git@github.com:lichaojacobs/pykylin.git</span><br><span class="line">cd pykylin</span><br><span class="line">pip install -r ./requirements.txt</span><br><span class="line">  python setup.py install</span><br><span class="line">  pip install pyldap</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改flask-appbuilder代码（重写了权限部分逻辑）</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flask-appbuilder/security/manager.py  auth_user_ldap (method)</span><br><span class="line">try:</span><br><span class="line">    user_db = self.auth_user_db(username,password)</span><br><span class="line">    if user_db!=None:</span><br><span class="line">       return user_db</span><br><span class="line"> 	except Exception:</span><br><span class="line">    log.info(&quot;using ldap and first try db_auth failed&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改superset源码（增加status接口，主要是对服务状态进行监测）</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from flask import jsonify</span><br><span class="line"> class MyIndexView(IndexView):</span><br><span class="line">   @expose(&apos;/&apos;)</span><br><span class="line">   def index(self):</span><br><span class="line">       return redirect(&apos;/superset/welcome&apos;)</span><br><span class="line">   @expose(&apos;/status&apos;)</span><br><span class="line">   def status(self):</span><br><span class="line">       return jsonify(status=&apos;ok&apos;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>修改superset config.py，加入缓存配置，ldap配置等</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">加上缓存：</span><br><span class="line"> CACHE_DEFAULT_TIMEOUT = 7200</span><br><span class="line"> CACHE_CONFIG = &#123;</span><br><span class="line">   &apos;CACHE_TYPE&apos;:&apos;redis&apos;,</span><br><span class="line">   &apos;CACHE_DEFAULT_TIMEOUT&apos;:7200,</span><br><span class="line">   &apos;CACHE_KEY_PREFIX&apos;:&apos;superset_&apos;,</span><br><span class="line">   &apos;CACHE_REDIS_HOST&apos;:&apos;xxxxxx.aliyuncs.com&apos;,</span><br><span class="line">   &apos;CACHE_REDIS_PORT&apos;:6379,</span><br><span class="line">   &apos;CACHE_REDIS_DB&apos;:&apos;&apos;,</span><br><span class="line">   &apos;CACHE_REDIS_PASSWORD&apos;:&apos;xxxxx&apos;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>加上GA脚本用于统计页面PV UV</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> (function(i,s,o,g,r,a,m)&#123;i[&apos;GoogleAnalyticsObject&apos;]=r;i[r]=i[r]||function()&#123;</span><br><span class="line"> (i[r].q=i[r].q||[]).push(arguments)&#125;,i[r].l=1*new Date();a=s.createElement(o),</span><br><span class="line"> m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</span><br><span class="line"> &#125;)(window,document,&apos;script&apos;,&apos;https://www.google-analytics.com/analytics.js&apos;,&apos;ga&apos;);</span><br><span class="line"></span><br><span class="line"> &#123;% if g.user.get_full_name %&#125;</span><br><span class="line"> ga(&apos;set&apos;, &apos;userId&apos;, &apos;&#123;&#123;g.user.get_full_name()&#125;&#125;&apos;);</span><br><span class="line"> &#123;% endif %&#125;</span><br><span class="line"> ga(&apos;create&apos;, &apos;UA-64695573-19&apos;, &apos;auto&apos;);</span><br><span class="line"> ga(&apos;send&apos;, &apos;pageview&apos;);</span><br><span class="line"></span><br><span class="line"> &lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>自编译superset</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $SUPERSET_HOME/superset/assets</span><br><span class="line">./js_build.sh</span><br><span class="line">#由于实际编译过程中出现了各种测试异常，我将npm run test,npm run cover去掉了</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>安装superset</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install build-essential libssl-dev libffi-dev python-dev python-pip libsasl2-dev libldap2-dev</span><br><span class="line">  apt-get install python3.5-dev</span><br><span class="line">pip install --upgrade setuptools pip</span><br><span class="line">#直接运行上一步编译好的文件</span><br><span class="line">python superset/setup.py install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>打包镜像，重新commit修改，并打上tag</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit -m &quot;superset docker init&quot; -a &quot;author&quot; &lt;container id&gt; &lt;docker repository host&gt;/superset:&lt;version&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行docker</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -m 1G --net=host &lt;docker repository host&gt;/superset:&lt;version&gt; superset runserver -p 8088 -t 500</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>虽然目前步子迈得有点小，但好在还在进步。在自己努力下，从之前痛苦的数据架构升级到现在，数据组的基础架构平台也算是稳定的在提供服务了。kylin也在啃了很久的源代码，做了一些优化之后从之前每天要挂三四次，数据主从同步问题每次执行任务都要重现到现在也能平稳运行。路还很长，想往底层钻的深一点，继续加油吧～</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-09-23T13:51:48.000Z">2017-09-23</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    11 分钟 读完 (大约 1661 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/09/23/lombok-builder-泛型擦除问题/">lombok builder 泛型擦除</a>
            
        </h1>
        <div class="content">
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><ul>
<li><p>众所周知，Java长期以来比较遭业界嫌弃的是太笨重，代码冗余过大。然而依托于Java庞大健全的开源社区，这些缺点正在逐渐改善。Java 8 引进的lambda以及函数式编程的思想让我们的代码越来越简洁。lombok等各大开源神器让我们的冗余代码越来越少。</p>
</li>
<li><p>使用lombok已经很长时间了，一直很好用，然而最近发现使用lombok builder构造泛型的时候会出现泛型擦除的情况，导致得到的对象是Object类型</p>
</li>
</ul>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><ul>
<li>定义一个待使用builder构造的泛型类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Builder</span><br><span class="line">public class PageableResponse&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  List&lt;T&gt; results;</span><br><span class="line">  @SerializedName(&quot;total_pages&quot;)</span><br><span class="line">  long totalPages;</span><br><span class="line">  @SerializedName(&quot;total_elements&quot;)</span><br><span class="line">  long totalElements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常情况下，我是可以这样使用的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public PageableResponse&lt;String&gt; getPageableResponse() &#123;</span><br><span class="line">  return PageableResponse</span><br><span class="line">      .builder()</span><br><span class="line">      .results(Lists.newArrayList())</span><br><span class="line">      .totalElements(0)</span><br><span class="line">      .totalPages(0)</span><br><span class="line">      .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而出现类型转换错误，PageableResponse.builder()生成的是PageableResponse.PageableResponseBuilder<code>&lt;Object&gt;</code> 想来也是，我这里调用builder方法时候并没有指定任何类型。</p>
<h3 id="泛型基础知识"><a href="#泛型基础知识" class="headerlink" title="泛型基础知识"></a>泛型基础知识</h3><p>那为什么会得到这样的结果？这里就要回顾一下泛型的知识了，这里我们的场景比较复杂一点，属于泛型类里面的静态泛型方法。这里提一下知识点：</p>
<h5 id="java泛型转换的几个事实："><a href="#java泛型转换的几个事实：" class="headerlink" title="java泛型转换的几个事实："></a>java泛型转换的几个事实：</h5><ul>
<li>虚拟机中没有泛型，只有普通的类和方法</li>
<li>无论何时定义一个泛型类型，都自动提供了一个相应的原始类型。原始类型的名字就是删去类型参数后的泛型类型名。擦除类型变量，替换为限定类型（无限定的变量用Object）。当程序调用泛型方法时，如果擦除返回类型，编译器插入强制类型转换</li>
<li>所有的类型参数都用它们的限定类型替换 如:Pair<code>&lt;T&gt;</code> 擦除类型之后就变成了Pair<code>&lt;Object&gt;</code></li>
<li>桥方法被合成来保持多态</li>
<li>为保证类型安全性，必要时插入强制类型转换</li>
</ul>
<h5 id="泛型的约束与局限性"><a href="#泛型的约束与局限性" class="headerlink" title="泛型的约束与局限性"></a>泛型的约束与局限性</h5><ul>
<li><p>不能用基本类型实例化类型参数</p>
</li>
<li><p>运行时类型查询只适用于原始类型:</p>
<ul>
<li>if(a instanceof Pair<code>&lt;String&gt;</code>)//ERROR</li>
<li><p>同理getClass方法也总是返回原始类型:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Pair&lt;String&gt; stringPair=...</span><br><span class="line">Pair&lt;Employ&gt; employPair=...</span><br><span class="line">if(stringPair.getClass()==employPair.getClass()) //True</span><br><span class="line">//两次调用都将返回Pair.class</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>不能创建参数化类型数组</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Pair&lt;String&gt;[] table = new Pair&lt;String&gt;[10]//ERROR</span><br><span class="line">//类型擦除之后，table的类型是Pair[]。可以把它转换为Object[]</span><br><span class="line">Object[] arr = table</span><br><span class="line">//数组会记住它的元素类型，如果试图存储其他类型的元素，会抛出ArrayStoreException异常</span><br><span class="line">//只是不允许创建这些数组，但是声明类型为Pair&lt;String&gt;[]的变量仍是合法的，只是不能用new Pair&lt;String&gt;[10]初始化这个变量</span><br><span class="line">//可以声明通配类型的数组，然后进行类型转换，导致的结果将是不安全的</span><br><span class="line">Pair&lt;String&gt;[] table = (Pair&lt;String&gt;[]) new Pair&lt;?&gt;[10];</span><br></pre></td></tr></table></figure>
</li>
<li><p>不能实例化类型变量: 不能new T(….)</p>
<ul>
<li>类型擦除会将T改变成Object，而且，本意肯定不希望调用new Object()</li>
<li><p>可以通过反射调用Class.newInstance方法来构造泛型对象，细节有点复杂</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//不能以下方式调用</span><br><span class="line">first = T.class.newInstance();//ERROR</span><br><span class="line">//表达式T.class是不合法的，必须如下方式才可以支配Class对象：</span><br><span class="line"></span><br><span class="line">public static&lt;T&gt; Pair&lt;T&gt; makePair(Class&lt;T&gt; cl)&#123;</span><br><span class="line">   try &#123; return new Pair&lt;&gt;(cl.newInstance(),cl.newInstance()) &#125;</span><br><span class="line">   catch (Exception ex) &#123; return null; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Pair&lt;String&gt; p = Pair.makePair(String.class);</span><br><span class="line">//注意，Class类本身就是泛型，String.class是一个Class&lt;String&gt;的实例（唯一实例）。因此makePair方法能够判断出pair的类型。</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>不能以如下的方式构造泛型数组</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//类型擦除会让这个方法永远构造Object[2]数组，而要求extends Comparable，这显然会抛出转换异常</span><br><span class="line">// 此时可以把 extends Comparable去掉，这样能保证强制转换的正确性</span><br><span class="line">public static &lt;T extends Comparable&gt; T[] minmax(T... a) &#123;</span><br><span class="line"></span><br><span class="line">   	Object[] mm = new Object[2];</span><br><span class="line">   	mm[0] = a[0];</span><br><span class="line">   	mm[1] = a[1];</span><br><span class="line"></span><br><span class="line">   	return (T[]) mm;</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> 	或者使用反射，调用Array.newInstance:</span><br><span class="line"></span><br><span class="line"> 	public static &lt;T extends Comparable&gt; T[] minmax(T... a) &#123;</span><br><span class="line"></span><br><span class="line">   	T[] mm = (T[]) Array.newInstance(a.getClass().getComponentType(), 2);</span><br><span class="line">   	...</span><br><span class="line"> 	&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="泛型类里面的泛型方法和静态泛型方法是有区别的："><a href="#泛型类里面的泛型方法和静态泛型方法是有区别的：" class="headerlink" title="泛型类里面的泛型方法和静态泛型方法是有区别的："></a>泛型类里面的泛型方法和静态泛型方法是有区别的：</h5><ul>
<li>泛型类定义的泛型 在整个类中有效 如果被方法使用，当泛型类确定类型之后，泛型方法也就确定类型了</li>
<li>而对于静态泛型方法而言，其泛型的类型是不依赖于泛型类的类型，也就是这两者的类型完全不相干（依据上一条的事实一）</li>
</ul>
<h5 id="泛型类型的继承规则"><a href="#泛型类型的继承规则" class="headerlink" title="泛型类型的继承规则"></a>泛型类型的继承规则</h5><ul>
<li>考虑一个类和一个子类，如Employee和Manager。Pair<code>&lt;Manager&gt;</code> 却不是Pair<code>&lt;Employee&gt;</code>的子类。事实上，它们的关系如下图所示</li>
</ul>
<p><img src="http://jacobs.wanhb.cn/images/generics1.png" alt=""></p>
<ul>
<li>泛型类可以扩展或实现其他泛型类。这一点与普通的类没什么区别。如：ArrayList<code>&lt;T&gt;</code> 类实现List<code>&lt;T&gt;</code>接口，意味着一个ArrayList<code>&lt;Manager&gt;</code> 可以被转换为一个List<code>&lt;Manager&gt;</code>。但是一个ArrayList<code>&lt;Manager&gt;</code> 不是一个ArrayList<code>&lt;Employee&gt;</code> 或者List<code>&lt;Employee&gt;</code>，它们的关系如下图:</li>
</ul>
<p><img src="http://jacobs.wanhb.cn/images/generics2.png" alt=""></p>
<h3 id="案例解释"><a href="#案例解释" class="headerlink" title="案例解释"></a>案例解释</h3><ul>
<li>泛型知识作了一番复习之后，我们再回到上面的案例。之所以无法正常的使用builder，是因为静态泛型方法不继承泛型类的类型。下面是案例类生成的代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class PageableResponse&lt;T&gt; &#123;</span><br><span class="line">  List&lt;T&gt; results;</span><br><span class="line">  @JSONField(</span><br><span class="line">    name = &quot;total_pages&quot;</span><br><span class="line">  )</span><br><span class="line">  long totalPages;</span><br><span class="line">  @JSONField(</span><br><span class="line">    name = &quot;total_elements&quot;</span><br><span class="line">  )</span><br><span class="line">  long totalElements;</span><br><span class="line"></span><br><span class="line">  //这个T不依赖于PageableResponse&lt;T&gt;的T</span><br><span class="line">  public static &lt;T&gt; PageableResponse.PageableResponseBuilder&lt;T&gt; builder() &#123;</span><br><span class="line">    return new PageableResponse.PageableResponseBuilder();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>而正常的没有泛型的生成代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Address &#123;</span><br><span class="line">  private String city;</span><br><span class="line"></span><br><span class="line">  //不带泛型</span><br><span class="line">  public static Address.AddressBuilder builder() &#123;</span><br><span class="line">    return new Address.AddressBuilder();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Address() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @ConstructorProperties(&#123;&quot;city&quot;&#125;)</span><br><span class="line">  public Address(String city) &#123;</span><br><span class="line">    this.city = city;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static class AddressBuilder &#123;</span><br><span class="line">    private String city;</span><br><span class="line"></span><br><span class="line">    AddressBuilder() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Address.AddressBuilder city(String city) &#123;</span><br><span class="line">      this.city = city;</span><br><span class="line">      return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Address build() &#123;</span><br><span class="line">      return new Address(this.city);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String toString() &#123;</span><br><span class="line">      return &quot;Address.AddressBuilder(city=&quot; + this.city + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>所以如果必须要使用泛型且如果这种情况不是太多的话，可以自己实现lombok的builder生成的代码，以案例定义的类为例，改造完的代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class PageableResponse&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  List&lt;T&gt; results;</span><br><span class="line">  @SerializedName(&quot;total_pages&quot;)</span><br><span class="line">  long totalPages;</span><br><span class="line">  @SerializedName(&quot;total_elements&quot;)</span><br><span class="line">  long totalElements;</span><br><span class="line"></span><br><span class="line">  //这里使用非静态方法的写法可以达到继承泛型类型的目的</span><br><span class="line">  public PageableResponseBuilder&lt;T&gt; builder() &#123;</span><br><span class="line">    return new PageableResponseBuilder&lt;T&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public class PageableResponseBuilder&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;T&gt; results;</span><br><span class="line">    long totalPages;</span><br><span class="line">    long totalElements;</span><br><span class="line"></span><br><span class="line">    public PageableResponseBuilder&lt;T&gt; totalPages(long totalPages) &#123;</span><br><span class="line">      this.totalPages = totalPages;</span><br><span class="line">      return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PageableResponseBuilder&lt;T&gt; totalElements(long totalElements) &#123;</span><br><span class="line">      this.totalElements = totalElements;</span><br><span class="line">      return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PageableResponseBuilder&lt;T&gt; results(List&lt;T&gt; results) &#123;</span><br><span class="line">      this.results = results;</span><br><span class="line">      return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PageableResponse&lt;T&gt; build() &#123;</span><br><span class="line">      return new PageableResponse&lt;&gt;(results, totalPages, totalElements);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-08-07T09:55:39.000Z">2017-08-07</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 分钟 读完 (大约 875 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/08/07/Kylin二次开发——测试环境搭建/">Kylin二次开发——测试环境搭建</a>
            
        </h1>
        <div class="content">
            <h3 id="调研背景"><a href="#调研背景" class="headerlink" title="调研背景"></a>调研背景</h3><p>虽然公司目前在生产环境上正式用上了kylin，但是由于其本身年龄不长，社区并不完善，难难免会暴露出各种各样的源码级别的问题(包括上一篇介绍的kylin的同步机制的问题)。这时候使用者想等着官方推出新的release未免太过于被动。于是，我们想着对kylin进行二次开发以满足我们对定制化需求。事实上，目前我们使用的所有开源框架在一定程度上都进行了多多少少的二次开发：</p>
<ul>
<li>superset接入kylin，完成了自编译集成进了docker，并修改了 flask-appbuilder的源码逻辑，兼容ldap与原本的账号系统。</li>
<li>airflow 正在考虑从输出信息中判断task是否执行成功，而不是单纯的靠进程是否异常退出判断（主要考虑到支持kylin的任务调度）</li>
</ul>
<p>其实在kylin的官网对于开发环境搭建大致的步骤都做了介绍下面描述整个过程</p>
<h3 id="搭建过程"><a href="#搭建过程" class="headerlink" title="搭建过程"></a>搭建过程</h3><ul>
<li><p>想应用经过自己二次开发的kylin当然必须得全覆盖的跑一遍所有的单元测试。这就意味着必须得有Hadoop+hive+hbase等一整套测试环境。这里使用kylin官方推荐的Hortonworks Sandbox。为了方便，直接使用Sandbox on docker。</p>
<ul>
<li><a href="https://hortonworks.com/tutorial/sandbox-deployment-and-install-guide/section/3/" target="_blank" rel="noopener">按照官网的教程（docker占用的内存至少8G以上，否则运行不了）</a></li>
<li>在执行start_sandbox-hdp.sh的时候需要往映射的端口里面加入hive metastore的thrift端口9083，否则本地跑单元测试的时候连不上metastore</li>
<li><p>ssh上运行的container，修改admin密码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2222 root@localhost</span><br><span class="line">或者http://127.0.0.1:4200/ 进入shell浏览器界面</span><br><span class="line">//执行</span><br><span class="line">  ambari-admin-password-reset</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>用修改的admin密码登录<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>，确保dashboard中hive+mapreduce+hdfs+hbase正常启动</p>
</li>
<li><p>修改kylin.properties的几个值:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//KYLIN_HOME/examples/test_case_data/sandbox/kylin.properties</span><br><span class="line"></span><br><span class="line">kylin.job.use-remote-cli=true</span><br><span class="line">kylin.job.remote-cli-hostname=sandbox</span><br><span class="line">kylin.job.remote-cli-username=root</span><br><span class="line">kylin.job.remote-cli-password=xxxx</span><br><span class="line">//这个默认是22端口，由于我本地不生效，就直接设置为2222端口</span><br><span class="line">kylin.job.remote-cli-port=2222</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>如果单个单元进行测试，不想每次从头开始，方便集中debug某个moudle的错误，可以注释掉pom.xml中的check-style插件</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- &lt;plugin&gt;</span><br><span class="line">                  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                  &lt;artifactId&gt;maven-checkstyle-plugin&lt;/artifactId&gt;</span><br><span class="line">                  &lt;version&gt;2.17&lt;/version&gt;</span><br><span class="line">                  &lt;dependencies&gt;</span><br><span class="line">                      &lt;dependency&gt;</span><br><span class="line">                          &lt;groupId&gt;com.puppycrawl.tools&lt;/groupId&gt;</span><br><span class="line">                          &lt;artifactId&gt;checkstyle&lt;/artifactId&gt;</span><br><span class="line">                          &lt;version&gt;6.19&lt;/version&gt;</span><br><span class="line">                      &lt;/dependency&gt;</span><br><span class="line">                  &lt;/dependencies&gt;</span><br><span class="line">                  &lt;executions&gt;</span><br><span class="line">                      &lt;execution&gt;</span><br><span class="line">                          &lt;id&gt;check-style&lt;/id&gt;</span><br><span class="line">                          &lt;phase&gt;validate&lt;/phase&gt;</span><br><span class="line">                          &lt;configuration&gt;</span><br><span class="line">                              &lt;configLocation&gt;dev-support/checkstyle.xml&lt;/configLocation&gt;</span><br><span class="line">                              &lt;suppressionsLocation&gt;dev-support/checkstyle-suppressions.xml&lt;/suppressionsLocation&gt;</span><br><span class="line">                              &lt;includeTestSourceDirectory&gt;true&lt;/includeTestSourceDirectory&gt;</span><br><span class="line">                              &lt;consoleOutput&gt;true&lt;/consoleOutput&gt;</span><br><span class="line">                              &lt;failsOnError&gt;true&lt;/failsOnError&gt;</span><br><span class="line">                          &lt;/configuration&gt;</span><br><span class="line">                          &lt;goals&gt;</span><br><span class="line">                              &lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">                          &lt;/goals&gt;</span><br><span class="line">                      &lt;/execution&gt;</span><br><span class="line">                  &lt;/executions&gt;</span><br><span class="line">              &lt;/plugin&gt; --&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>执行测试命令</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//base</span><br><span class="line">mvn test -fae -Dhdp.version=$&#123;HDP_VERSION:-&quot;2.6.1.0-129&quot;&#125; -P sandbox -X</span><br><span class="line">//全覆盖</span><br><span class="line">mvn verify -Dhdp.version=$&#123;HDP_VERSION:-&quot;2.6.1.0-129&quot;&#125; -fae 2&gt;&amp;1 | tee mvnverify.log</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h3><ul>
<li><p>该暴露的端口得暴露出来，否则本地测试的时候对指定的端口无法进行tcp通信</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">9083:9083 //hive metastore</span><br><span class="line">8050:8050 // kylin 获取job output信息端口</span><br><span class="line">50010:50010 // dfs.datanode.address，这里踩坑很久,不配置的话会有：createBlockOutputStream when copying data into HDFS错误</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动start_sandbox-hdp脚本的时候，可能会出现postgresql服务启动不了，这很可能是因为其申请的共享内存超过了系统的，只需要进入到容器里面做相关操作</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh -p root@localhost</span><br><span class="line">sudo sysctl -w kernel.shmmax=17179869184 //假设你有16G内存，按实际扩充</span><br><span class="line">sudo service postgresql start</span><br><span class="line">//postgresql启动之后在容器外重新执行</span><br><span class="line">./start_sandbox-hdp.sh 就可以了</span><br></pre></td></tr></table></figure>
</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-07-06T07:11:38.000Z">2017-07-06</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 分钟 读完 (大约 1962 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/07/06/kylin-master-slave同步原理及问题排查/">kylin master-slave同步原理及问题排查</a>
            
        </h1>
        <div class="content">
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近俩个月，团队整个数据基础架构慢慢转移到kylin上面来。而kylin也不负众望，对于一些复杂的聚合查询响应速度远超于hive。随着数据量的上来，kylin的单体部署逐渐无法支撑大量的并行读写任务。于是，自然而然的考虑到kylin的读写分离。一写多读，正好也符合kylin官方文档上的cluster架构。然而在实际的使用中也出现了一些问题:</p>
<ul>
<li>主节点更新了schema而从节点未sync</li>
<li>从节点中部分sync成功，而不是全部</li>
</ul>
<p>而很明显的是kylin中所有的数据，包括所有元数据都是落地在HBase中的，那唯一导致节点间数据不一致的可能就只有各个节点都有本地缓存的情况了。为了理解原理方便debug，我对kylin master-slave的同步原理做了一些源代码层面的剖析。</p>
<h3 id="原理剖析"><a href="#原理剖析" class="headerlink" title="原理剖析"></a>原理剖析</h3><h4 id="主从配置方式"><a href="#主从配置方式" class="headerlink" title="主从配置方式"></a>主从配置方式</h4><p>关于配置的格式，不得不吐槽官方文档的滑水。并没有给出详细的节点配置格式，查阅相关源码才发现正确的配置格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//kylin.properties下面的配置，根据源码，配置的格式为：user:pwd@host:port</span><br><span class="line">kylin.server.cluster-servers=user:password@host:port,user:password@host:port,user:password@host:port</span><br></pre></td></tr></table></figure>
<h4 id="流程解析"><a href="#流程解析" class="headerlink" title="流程解析"></a>流程解析</h4><p><img src="http://jacobs.wanhb.cn/images/master-slave-kylin.png" alt="流程解析"></p>
<h4 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h4><ul>
<li><p>先来看看整个同步机制的核心BroadCaster类的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">//Broadcaster的构造函数</span><br><span class="line">private Broadcaster(final KylinConfig config) &#123;</span><br><span class="line">      this.config = config;</span><br><span class="line">      //获取kylin.properties中&quot;kylin.server.cluster-servers&quot;配置的值</span><br><span class="line">      //也就是集群中所有节点的配置了</span><br><span class="line">      final String[] nodes = config.getRestServers();</span><br><span class="line">      if (nodes == null || nodes.length &lt; 1) &#123;</span><br><span class="line">          logger.warn(&quot;There is no available rest server; check the &apos;kylin.server.cluster-servers&apos; config&quot;);</span><br><span class="line">          broadcastEvents = null; // disable the broadcaster</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      logger.debug(nodes.length + &quot; nodes in the cluster: &quot; + Arrays.toString(nodes));</span><br><span class="line"></span><br><span class="line">      //开一个单线程，不间断的循环从broadcastEvents队列里面获取注册的事件。</span><br><span class="line">      Executors.newSingleThreadExecutor(new DaemonThreadFactory()).execute(new Runnable() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public void run() &#123;</span><br><span class="line">              final List&lt;RestClient&gt; restClients = Lists.newArrayList();</span><br><span class="line">              for (String node : config.getRestServers()) &#123;</span><br><span class="line">                  //根据配置的节点信息注册RestClient</span><br><span class="line">                  restClients.add(new RestClient(node));</span><br><span class="line">              &#125;</span><br><span class="line">              final ExecutorService wipingCachePool = Executors.newFixedThreadPool(restClients.size(), new DaemonThreadFactory());</span><br><span class="line">              while (true) &#123;</span><br><span class="line">                  try &#123;</span><br><span class="line">                      final BroadcastEvent broadcastEvent = broadcastEvents.takeFirst();</span><br><span class="line">                      logger.info(&quot;Announcing new broadcast event: &quot; + broadcastEvent);</span><br><span class="line">                      for (final RestClient restClient : restClients) &#123;</span><br><span class="line">                          wipingCachePool.execute(new Runnable() &#123;</span><br><span class="line">                              @Override</span><br><span class="line">                              public void run() &#123;</span><br><span class="line">                                  try &#123;</span><br><span class="line">                                      restClient.wipeCache(broadcastEvent.getEntity(), broadcastEvent.getEvent(), broadcastEvent.getCacheKey());</span><br><span class="line">                                  &#125; catch (IOException e) &#123;</span><br><span class="line">                                      logger.warn(&quot;Thread failed during wipe cache at &quot; + broadcastEvent, e);</span><br><span class="line">                                  &#125;</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; catch (Exception e) &#123;</span><br><span class="line">                      logger.error(&quot;error running wiping&quot;, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>通过Broadcaster的构造函数其实就能清楚整个同步过程的大概逻辑了。无非就是启动一个线程去轮询阻塞队列里面的元素，有的话就消费下来广播到其他从节点从而达到清理缓存的目的。</p>
</li>
<li><p>再来看看广播的实际逻辑实现,基本封装在RestClient中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//此处是根据配置的节点信息正则匹配：&quot;user:pwd@host:port&quot;</span><br><span class="line">public RestClient(String uri) &#123;</span><br><span class="line">   Matcher m = fullRestPattern.matcher(uri);</span><br><span class="line">   if (!m.matches())</span><br><span class="line">       throw new IllegalArgumentException(&quot;URI: &quot; + uri + &quot; -- does not match pattern &quot; + fullRestPattern);</span><br><span class="line"></span><br><span class="line">   String user = m.group(1);</span><br><span class="line">   String pwd = m.group(2);</span><br><span class="line">   String host = m.group(3);</span><br><span class="line">   String portStr = m.group(4);</span><br><span class="line">   int port = Integer.parseInt(portStr == null ? &quot;7070&quot; : portStr);</span><br><span class="line"></span><br><span class="line">   init(host, port, user, pwd);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>根据配置的节点信息实例化RestClient，然后在init方法中，拼接wipe cache的url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private void init(String host, int port, String userName, String password) &#123;</span><br><span class="line">  this.host = host;</span><br><span class="line">  this.port = port;</span><br><span class="line">  this.userName = userName;</span><br><span class="line">  this.password = password;</span><br><span class="line">  //拼接rest接口</span><br><span class="line">  this.baseUrl = &quot;http://&quot; + host + &quot;:&quot; + port + &quot;/kylin/api&quot;;</span><br><span class="line"></span><br><span class="line">  client = new DefaultHttpClient();</span><br><span class="line"></span><br><span class="line">  if (userName != null &amp;&amp; password != null) &#123;</span><br><span class="line">      CredentialsProvider provider = new BasicCredentialsProvider();</span><br><span class="line">      UsernamePasswordCredentials credentials = new UsernamePasswordCredentials(userName, password);</span><br><span class="line">      provider.setCredentials(AuthScope.ANY, credentials);</span><br><span class="line">      client.setCredentialsProvider(provider);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现kylin所有的交互接口基本上底层都是调用的自己的rest接口，它自己所谓的jdbc的查询方式其实也只是在rest接口上封装了一层，底层还是http请求。可谓是挂羊头卖狗肉了。看看RestClient中怎么去通知其他节点wipe cache的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void wipeCache(String entity, String event, String cacheKey) throws IOException &#123;</span><br><span class="line">   String url = baseUrl + &quot;/cache/&quot; + entity + &quot;/&quot; + cacheKey + &quot;/&quot; + event;</span><br><span class="line">   HttpPut request = new HttpPut(url);</span><br><span class="line"></span><br><span class="line">   try &#123;</span><br><span class="line">       HttpResponse response = client.execute(request);</span><br><span class="line">       String msg = EntityUtils.toString(response.getEntity());</span><br><span class="line"></span><br><span class="line">       if (response.getStatusLine().getStatusCode() != 200)</span><br><span class="line">           throw new IOException(&quot;Invalid response &quot; + response.getStatusLine().getStatusCode() + &quot; with cache wipe url &quot; + url + &quot;\n&quot; + msg);</span><br><span class="line">   &#125; catch (Exception ex) &#123;</span><br><span class="line">       throw new IOException(ex);</span><br><span class="line">   &#125; finally &#123;</span><br><span class="line">       request.releaseConnection();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>已经很明了了，就是调的rest接口：/kylin/api/cache/{entity}/{cacaheKey}/{event}</p>
</li>
<li><p>当slave节点接收到wipeCache的指令时的处理逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void notifyMetadataChange(String entity, Event event, String cacheKey) throws IOException &#123;</span><br><span class="line">     Broadcaster broadcaster = Broadcaster.getInstance(getConfig());</span><br><span class="line"></span><br><span class="line">     //这里会判断当前节点是否注册为listener了，如果注册了，此逻辑会被ignored</span><br><span class="line">     broadcaster.registerListener(cacheSyncListener, &quot;cube&quot;);</span><br><span class="line"></span><br><span class="line">     broadcaster.notifyListener(entity, event, cacheKey);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> //注册listener的逻辑</span><br><span class="line"> public void registerListener(Listener listener, String... entities) &#123;</span><br><span class="line">  synchronized (CACHE) &#123;</span><br><span class="line">      // ignore re-registration</span><br><span class="line">      List&lt;Listener&gt; all = listenerMap.get(SYNC_ALL);</span><br><span class="line">      if (all != null &amp;&amp; all.contains(listener)) &#123;</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      for (String entity : entities) &#123;</span><br><span class="line">          if (!StringUtils.isBlank(entity))</span><br><span class="line">              addListener(entity, listener);</span><br><span class="line">      &#125;</span><br><span class="line">      //注册几种事件类型</span><br><span class="line">      addListener(SYNC_ALL, listener);</span><br><span class="line">      addListener(SYNC_PRJ_SCHEMA, listener);</span><br><span class="line">      addListener(SYNC_PRJ_DATA, listener);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>notifyListener主要就是对所有事件处理逻辑的划分，根据事件类型选择处理逻辑，一般sheme的更新走的是默认逻辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public void notifyListener(String entity, Event event, String cacheKey) throws IOException &#123;</span><br><span class="line">     synchronized (CACHE) &#123;</span><br><span class="line">         List&lt;Listener&gt; list = listenerMap.get(entity);</span><br><span class="line">         if (list == null)</span><br><span class="line">             return;</span><br><span class="line"></span><br><span class="line">         logger.debug(&quot;Broadcasting metadata change: entity=&quot; + entity + &quot;, event=&quot; + event + &quot;, cacheKey=&quot; + cacheKey + &quot;, listeners=&quot; + list);</span><br><span class="line"></span><br><span class="line">         // prevents concurrent modification exception</span><br><span class="line">         list = Lists.newArrayList(list);</span><br><span class="line">         switch (entity) &#123;</span><br><span class="line">         case SYNC_ALL:</span><br><span class="line">             for (Listener l : list) &#123;</span><br><span class="line">                 l.onClearAll(this);</span><br><span class="line">             &#125;</span><br><span class="line">             clearCache(); // clear broadcaster too in the end</span><br><span class="line">             break;</span><br><span class="line">         case SYNC_PRJ_SCHEMA:</span><br><span class="line">             ProjectManager.getInstance(config).clearL2Cache();</span><br><span class="line">             for (Listener l : list) &#123;</span><br><span class="line">                 l.onProjectSchemaChange(this, cacheKey);</span><br><span class="line">             &#125;</span><br><span class="line">             break;</span><br><span class="line">         case SYNC_PRJ_DATA:</span><br><span class="line">             ProjectManager.getInstance(config).clearL2Cache(); // cube&apos;s first becoming ready leads to schema change too</span><br><span class="line">             for (Listener l : list) &#123;</span><br><span class="line">                 l.onProjectDataChange(this, cacheKey);</span><br><span class="line">             &#125;</span><br><span class="line">             break;</span><br><span class="line">         //大部分的走向</span><br><span class="line">         default:</span><br><span class="line">             for (Listener l : list) &#123;</span><br><span class="line">                 l.onEntityChange(this, entity, event, cacheKey);</span><br><span class="line">             &#125;</span><br><span class="line">             break;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         logger.debug(&quot;Done broadcasting metadata change: entity=&quot; + entity + &quot;, event=&quot; + event + &quot;, cacheKey=&quot; + cacheKey);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>看到default分支会执行onEntityChange这个方法，看一下这个方法干的是什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private Broadcaster.Listener cacheSyncListener = new Broadcaster.Listener() &#123;</span><br><span class="line">   @Override</span><br><span class="line">   public void onClearAll(Broadcaster broadcaster) throws IOException &#123;</span><br><span class="line">       removeAllOLAPDataSources();</span><br><span class="line">       cleanAllDataCache();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void onProjectSchemaChange(Broadcaster broadcaster, String project) throws IOException &#123;</span><br><span class="line">       removeOLAPDataSource(project);</span><br><span class="line">       cleanDataCache(project);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void onProjectDataChange(Broadcaster broadcaster, String project) throws IOException &#123;</span><br><span class="line">       removeOLAPDataSource(project); // data availability (cube enabled/disabled) affects exposed schema to SQL</span><br><span class="line">       cleanDataCache(project);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void onEntityChange(Broadcaster broadcaster, String entity, Event event, String cacheKey) throws IOException &#123;</span><br><span class="line">       if (&quot;cube&quot;.equals(entity) &amp;&amp; event == Event.UPDATE) &#123;</span><br><span class="line">           final String cubeName = cacheKey;</span><br><span class="line">           new Thread() &#123; // do not block the event broadcast thread</span><br><span class="line">               public void run() &#123;</span><br><span class="line">                   try &#123;</span><br><span class="line">                       Thread.sleep(1000);</span><br><span class="line">                       cubeService.updateOnNewSegmentReady(cubeName);</span><br><span class="line">                   &#125; catch (Throwable ex) &#123;</span><br><span class="line">                       logger.error(&quot;Error in updateOnNewSegmentReady()&quot;, ex);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;.start();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>看到对于cache的同步是单独实现了一个listener的，Event为update的时候，会单独启动一个线程去执行刷新缓存操作</p>
</li>
</ul>
<h3 id="加入简单的重试逻辑"><a href="#加入简单的重试逻辑" class="headerlink" title="加入简单的重试逻辑"></a>加入简单的重试逻辑</h3><p>由于目前对于同步失败的猜想是目标服务短暂不可用（响应超时或者处于失败重启阶段），于是我只是单纯的将失败的任务重新塞入broadcastEvents队列尾部供再一次调用。当然这种操作过于草率和暴力，却也是验证猜想最简单快速的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">for (final RestClient restClient : restClients) &#123;</span><br><span class="line">           wipingCachePool.execute(new Runnable() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void run() &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                 restClient.wipeCache(broadcastEvent.getEntity(), broadcastEvent.getEvent(),</span><br><span class="line">                     broadcastEvent.getCacheKey());</span><br><span class="line">               &#125; catch (IOException e) &#123;</span><br><span class="line">                 logger</span><br><span class="line">                     .warn(&quot;Thread failed during wipe cache at &#123;&#125;, error msg: &#123;&#125;&quot;, broadcastEvent,</span><br><span class="line">                         e.getMessage());</span><br><span class="line">                 try &#123;</span><br><span class="line">                   //这里重新塞入队列尾部，等待重新执行</span><br><span class="line">                   broadcastEvents.putLast(broadcastEvent);</span><br><span class="line">                   logger.info(&quot;put failed broadcastEvent to queue. broacastEvent: &#123;&#125;&quot;,</span><br><span class="line">                       broadcastEvent);</span><br><span class="line">                 &#125; catch (InterruptedException ex) &#123;</span><br><span class="line">                   logger.warn(&quot;error reentry failed broadcastEvent to queue, broacastEvent:&#123;&#125;, error: &#123;&#125; &quot;,</span><br><span class="line">                       broadcastEvent, ex);</span><br><span class="line">                 &#125;</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>编译部署之后，日志中出现了如下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread failed during wipe cache at java.lang.IllegalStateException: Invalid use of BasicClientConnManager: connection still allocated.</span><br></pre></td></tr></table></figure>
<p>比较意外，不过也终于发现了问题的所在。Kylin在启动的时候会按照配置的nodes实例化一次RestClient，之后就直接从缓存中拿了，而kylin用的DefaultHttpClient每次只允许一次请求，请求完必须释放链接，否则无法复用HttpClient。所以需要修改wipeCache方法的逻辑如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void wipeCache(String entity, String event, String cacheKey) throws IOException &#123;</span><br><span class="line">    String url = baseUrl + &quot;/cache/&quot; + entity + &quot;/&quot; + cacheKey + &quot;/&quot; + event;</span><br><span class="line">    HttpPut request = new HttpPut(url);</span><br><span class="line"></span><br><span class="line">    HttpResponse response =null;</span><br><span class="line">    try &#123;</span><br><span class="line">        response = client.execute(request);</span><br><span class="line">        String msg = EntityUtils.toString(response.getEntity());</span><br><span class="line"></span><br><span class="line">        if (response.getStatusLine().getStatusCode() != 200)</span><br><span class="line">            throw new IOException(&quot;Invalid response &quot; + response.getStatusLine().getStatusCode() + &quot; with cache wipe url &quot; + url + &quot;\n&quot; + msg);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">        throw new IOException(ex);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //确保释放连接</span><br><span class="line">        if(response!=null) &#123;</span><br><span class="line">          EntityUtils.consume(response.getEntity());</span><br><span class="line">        &#125;</span><br><span class="line">        request.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-06-24T18:50:37.000Z">2017-06-25</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 分钟 读完 (大约 186 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/06/25/HBase架构脑图/">HBase架构脑图</a>
            
        </h1>
        <div class="content">
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近，由于我司数据基础新架构正在陆续往以Kylin为中心的方向上走，而Kylin的底层存储又是重度依赖HBase，为了保证数据服务的稳定性，无奈最近开始研究HBase的源码以及工作原理。翻阅各种书籍博客之余，大致总结了一张初期的HBase架构脑图，之后会随着认知的深入去不断更新。结合源码方面的分析也会陆续进行…比较蛋疼的是，HBase的源码太过庞大，不如Kylin的结构清晰，慢慢看吧…</p>
<h3 id="脑图"><a href="#脑图" class="headerlink" title="脑图"></a>脑图</h3><p><img src="https://pic1.zhimg.com/80/v2-a0a55482bb8c93edfedc2eb59c678424_hd.png" alt="HBase 架构图"></p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/page/3/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/">1</a></li>
            
            <li><a class="pagination-link is-current" href="/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/3/">3</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/profile.jpg" alt="CHAO LI">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        CHAO LI
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Big Data
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Beijing</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            30
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            0
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            39
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/ppoffice/hexo-theme-icarus">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://github.com/lichaojacobs" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Github</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.zhihu.com/people/chao-li-11" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">知乎</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.zhihu.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://weibo.com/3101672623/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">微博</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">weibo.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/BigData/" style="font-size: 10px;">BigData</a> <a href="/tags/Crawler/" style="font-size: 10px;">Crawler</a> <a href="/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Hbase/" style="font-size: 12.5px;">Hbase</a> <a href="/tags/InnoDB/" style="font-size: 10px;">InnoDB</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Kylin/" style="font-size: 10px;">Kylin</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/ReentrantLock/" style="font-size: 10px;">ReentrantLock</a> <a href="/tags/Spark/" style="font-size: 17.5px;">Spark</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/Yarn/" style="font-size: 15px;">Yarn</a> <a href="/tags/aop/" style="font-size: 12.5px;">aop</a> <a href="/tags/data/" style="font-size: 10px;">data</a> <a href="/tags/infrastructure/" style="font-size: 12.5px;">infrastructure</a> <a href="/tags/ioc/" style="font-size: 12.5px;">ioc</a> <a href="/tags/java8/" style="font-size: 10px;">java8</a> <a href="/tags/kylin/" style="font-size: 12.5px;">kylin</a> <a href="/tags/kylin-Java-源码/" style="font-size: 12.5px;">kylin - Java - 源码</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/paper/" style="font-size: 10px;">paper</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/spark/" style="font-size: 10px;">spark</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/sqlGenerator/" style="font-size: 10px;">sqlGenerator</a> <a href="/tags/superset/" style="font-size: 10px;">superset</a> <a href="/tags/事务处理/" style="font-size: 10px;">事务处理</a> <a href="/tags/二次开发/" style="font-size: 10px;">二次开发</a> <a href="/tags/函数式编程/" style="font-size: 10px;">函数式编程</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/大数据/" style="font-size: 20px;">大数据</a> <a href="/tags/学习/" style="font-size: 17.5px;">学习</a> <a href="/tags/成长/" style="font-size: 17.5px;">成长</a> <a href="/tags/架构/" style="font-size: 17.5px;">架构</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T17:42:13.000Z">2020-01-07</time></div>
                    <a href="/2020/01/07/MR任务在Hadoop子系统中状态流转/" class="title has-link-black-ter is-size-6 has-text-weight-normal">MR任务在Hadoop子系统中状态流转</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-04T17:47:46.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/Yarn-Federation源码串读/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Yarn Federation源码串读</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-04T17:38:28.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/Hadoop-Rpc源码分析/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Hadoop Rpc源码分析</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-10T05:08:55.000Z">2019-06-10</time></div>
                    <a href="/2019/06/10/【Spark源码分析】Job提交执行过程详解/" class="title has-link-black-ter is-size-6 has-text-weight-normal">【Spark源码分析】Job提交执行过程详解</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-02T05:31:16.000Z">2019-06-02</time></div>
                    <a href="/2019/06/02/【Spark源码分析】Broadcast/" class="title has-link-black-ter is-size-6 has-text-weight-normal">【Spark源码分析】Broadcast</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/02/">
                <span class="level-start">
                    <span class="level-item">二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BigData/">
                        <span class="tag">BigData</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Crawler/">
                        <span class="tag">Crawler</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HBase/">
                        <span class="tag">HBase</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hadoop/">
                        <span class="tag">Hadoop</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hbase/">
                        <span class="tag">Hbase</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/InnoDB/">
                        <span class="tag">InnoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Kylin/">
                        <span class="tag">Kylin</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Python/">
                        <span class="tag">Python</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantLock/">
                        <span class="tag">ReentrantLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spark/">
                        <span class="tag">Spark</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Yarn/">
                        <span class="tag">Yarn</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/aop/">
                        <span class="tag">aop</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/data/">
                        <span class="tag">data</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/infrastructure/">
                        <span class="tag">infrastructure</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ioc/">
                        <span class="tag">ioc</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java8/">
                        <span class="tag">java8</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/kylin/">
                        <span class="tag">kylin</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/kylin-Java-源码/">
                        <span class="tag">kylin - Java - 源码</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mysql/">
                        <span class="tag">mysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/paper/">
                        <span class="tag">paper</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/python/">
                        <span class="tag">python</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spark/">
                        <span class="tag">spark</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring/">
                        <span class="tag">spring</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sqlGenerator/">
                        <span class="tag">sqlGenerator</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/superset/">
                        <span class="tag">superset</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/事务处理/">
                        <span class="tag">事务处理</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二次开发/">
                        <span class="tag">二次开发</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/函数式编程/">
                        <span class="tag">函数式编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分布式/">
                        <span class="tag">分布式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/大数据/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/学习/">
                        <span class="tag">学习</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/成长/">
                        <span class="tag">成长</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/架构/">
                        <span class="tag">架构</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/读书/">
                        <span class="tag">读书</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T17:42:13.000Z">2020-01-07</time></div>
                    <a href="/2020/01/07/MR任务在Hadoop子系统中状态流转/" class="title has-link-black-ter is-size-6 has-text-weight-normal">MR任务在Hadoop子系统中状态流转</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-04T17:47:46.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/Yarn-Federation源码串读/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Yarn Federation源码串读</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-04T17:38:28.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/Hadoop-Rpc源码分析/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Hadoop Rpc源码分析</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-10T05:08:55.000Z">2019-06-10</time></div>
                    <a href="/2019/06/10/【Spark源码分析】Job提交执行过程详解/" class="title has-link-black-ter is-size-6 has-text-weight-normal">【Spark源码分析】Job提交执行过程详解</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-02T05:31:16.000Z">2019-06-02</time></div>
                    <a href="/2019/06/02/【Spark源码分析】Broadcast/" class="title has-link-black-ter is-size-6 has-text-weight-normal">【Spark源码分析】Broadcast</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/02/">
                <span class="level-start">
                    <span class="level-item">二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BigData/">
                        <span class="tag">BigData</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Crawler/">
                        <span class="tag">Crawler</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HBase/">
                        <span class="tag">HBase</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hadoop/">
                        <span class="tag">Hadoop</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Hbase/">
                        <span class="tag">Hbase</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/InnoDB/">
                        <span class="tag">InnoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Kylin/">
                        <span class="tag">Kylin</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Python/">
                        <span class="tag">Python</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ReentrantLock/">
                        <span class="tag">ReentrantLock</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spark/">
                        <span class="tag">Spark</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Yarn/">
                        <span class="tag">Yarn</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/aop/">
                        <span class="tag">aop</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/data/">
                        <span class="tag">data</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/infrastructure/">
                        <span class="tag">infrastructure</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ioc/">
                        <span class="tag">ioc</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java8/">
                        <span class="tag">java8</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/kylin/">
                        <span class="tag">kylin</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/kylin-Java-源码/">
                        <span class="tag">kylin - Java - 源码</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mysql/">
                        <span class="tag">mysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/paper/">
                        <span class="tag">paper</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/python/">
                        <span class="tag">python</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spark/">
                        <span class="tag">spark</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/spring/">
                        <span class="tag">spring</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/sqlGenerator/">
                        <span class="tag">sqlGenerator</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/superset/">
                        <span class="tag">superset</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/事务处理/">
                        <span class="tag">事务处理</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二次开发/">
                        <span class="tag">二次开发</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/函数式编程/">
                        <span class="tag">函数式编程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分布式/">
                        <span class="tag">分布式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/大数据/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/学习/">
                        <span class="tag">学习</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/成长/">
                        <span class="tag">成长</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/架构/">
                        <span class="tag">架构</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/读书/">
                        <span class="tag">读书</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/hadoop_logo.jpg" alt="CHAO LI&#39;s Blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 John Doe&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                <br>
                <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://yoursite.com',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>